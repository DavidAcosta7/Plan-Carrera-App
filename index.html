<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v1.0.2 - Fix getCurrentUser method -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Plan Carrera Pro - Crea tu Plan de Carrera con IA</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/landing.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="css/register.css">
    <link rel="stylesheet" href="css/onboarding.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/projects.css">
    <link rel="stylesheet" href="css/plan-detail.css">
    <link rel="stylesheet" href="css/carrerbot.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Inyectar variables de entorno en global -->
    <script>
        // Configuraci√≥n de Supabase
        window.SUPABASE_CONFIG = {
            url: 'https://illzdmhlkhnooykecqkv.supabase.co',
            anonKey: 'sb_publishable_VeO6VB6HFb75x0Nk5_6roQ_Wbt_oxPI'
        };
        // Backend API (Groq AI) - chatbot del dashboard
        window.API_BASE_URL = window.API_BASE_URL || 'http://127.0.0.1:8000';
        console.log('üìù Variables de Supabase inyectadas en window.SUPABASE_CONFIG');
    </script>
    
    <!-- Supabase Client -->
    <script src="utils/supabase-client.js"></script>
    
    <!-- IA: n√∫cleo Groq en backend (sin Claude en frontend) -->
    
    <!-- Plan Service (Database Management) -->
    <script src="utils/plan-service.js"></script>
    
    <!-- Auth Service (Mejorado) -->
    <script src="utils/auth-service.js"></script>
    <!-- Chatbot Sidebar (Dashboard) -->
    <script src="utils/chatbot-sidebar.js"></script>
</head>
<body>
    <!-- Pantalla de carga FUERA de #app para que no se destruya al renderizar -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Cargando...</h2>
        </div>
    </div>
    <div id="app"></div>

    <script>
        // Sistema de Routing SPA
        class Router {
            constructor() {
                this.routes = {};
                this.currentRoute = null;
                this.container = document.getElementById('app');
                this.init();
            }

            init() {
                // Escuchar cambios en el hash
                window.addEventListener('hashchange', () => this.handleRoute());
                window.addEventListener('load', () => this.handleRoute());
                
                // Manejar clicks en enlaces
                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-route]')) {
                        e.preventDefault();
                        const route = e.target.getAttribute('data-route');
                        this.navigate(route);
                    }
                });
            }

            addRoute(path, content) {
                this.routes[path] = content;
            }

            navigate(path) {
                window.location.hash = path;
            }

            async handleRoute() {
                const loadingEl = document.getElementById('loadingScreen');
                try {
                    const hash = (window.location.hash || '#/').replace(/^#/, '') || '/';
                    const isFileProtocol = window.location.protocol === 'file:';

                    // Ruta din√°mica: vista detalle de plan /dashboard/plan/[planId]
                    if (hash.startsWith('/dashboard/plan/')) {
                        const planId = hash.replace(/^\/dashboard\/plan\//, '').split('/')[0];
                        if (planId) {
                            try {
                                if (!isFileProtocol) {
                                    const res = await fetch('./pages/plan-detail.html');
                                    const content = await res.text();
                                    this.currentRoute = content;
                                    this.render(content);
                                    setTimeout(() => { if (window.loadPlanDetail) window.loadPlanDetail(); }, 100);
                                } else {
                                    this.container.innerHTML = '<p>No disponible en modo archivo. Abre con http o usa la vista inline.</p>';
                                }
                            } catch (e) {
                                console.error('Error cargando vista de plan:', e);
                                this.container.innerHTML = '<div class="error">Error cargando el plan. <a href="#/dashboard" data-route="/dashboard">Volver al Dashboard</a></div>';
                            }
                        }
                        return;
                    }
                    // Compatibilidad: /dashboard/plans/[planId]
                    if (hash.startsWith('/dashboard/plans/')) {
                        const planId = hash.replace(/^\/dashboard\/plans\//, '').split('/')[0];
                        if (planId) {
                            try {
                                const res = await fetch('./pages/plan-detail.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                                setTimeout(() => {
                                    if (window.loadPlanDetail) window.loadPlanDetail();
                                }, 100);
                            } catch (e) {
                                console.error('Error cargando vista de plan:', e);
                                this.container.innerHTML = '<div class="error">Error cargando el plan. <a href="#/dashboard" data-route="/dashboard">Volver al Dashboard</a></div>';
                            }
                        }
                        return;
                    }

                    // Dashboard: cargar desde archivo dedicado
                    if (hash === '/dashboard') {
                        try {
                            if (!isFileProtocol) {
                                const res = await fetch('./pages/dashboard.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                            } else {
                                const content = this.routes['/dashboard'] || this.routes['/'];
                                this.currentRoute = content;
                                this.render(content);
                            }
                            setTimeout(() => {
                                if (window.loadDashboard) window.loadDashboard();
                                if (window.initChatbotSidebar) window.initChatbotSidebar();
                            }, 100);
                        } catch (e) {
                            console.error('Error cargando dashboard:', e);
                            this.container.innerHTML = '<div class="error">Error cargando dashboard. <a href="#/" data-route="/">Volver</a></div>';
                        }
                        return;
                    }

                    // Onboarding: cargar desde archivo dedicado como las otras p√°ginas
                    if (hash === '/onboarding') {
                        try {
                            if (!isFileProtocol) {
                                const res = await fetch('./pages/onboarding.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                                setTimeout(() => {
                                    if (window.initOnboarding) window.initOnboarding();
                                }, 100);
                            } else {
                                // Para file://, usar contenido inline como fallback
                                const content = this.routes['/onboarding'] || onboardingContent || '';
                                this.currentRoute = content;
                                this.render(content);
                                setTimeout(() => {
                                    if (window.initOnboarding) window.initOnboarding();
                                }, 100);
                            }
                        } catch (e) {
                            console.error('Error cargando onboarding:', e);
                            // Fallback a contenido inline
                            const content = this.routes['/onboarding'] || onboardingContent || '';
                            this.currentRoute = content;
                            this.render(content);
                            setTimeout(() => {
                                if (window.initOnboarding) window.initOnboarding();
                            }, 100);
                        }
                        return;
                    }

                    // Projects: cargar desde archivo dedicado
                    if (hash === '/projects') {
                        try {
                            const res = await fetch('./pages/projects.html');
                            const content = await res.text();
                            this.currentRoute = content;
                            this.render(content);
                            setTimeout(() => {
                                if (window.initProjectsPage) window.initProjectsPage();
                            }, 100);
                        } catch (e) {
                            console.error('Error cargando projects:', e);
                            this.container.innerHTML = '<div class="error">Error cargando projects. <a href="#/" data-route="/">Volver</a></div>';
                        }
                        return;
                    }

                    // Rutas est√°ticas: landing, login, register (cargar desde pages/ o inline seg√∫n protocolo)
                    if (hash === '/' || hash === '') {
                        try {
                            if (!isFileProtocol) {
                                const res = await fetch('./pages/landing.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                            } else {
                                const content = this.routes['/'] || (typeof landingContent !== 'undefined' ? landingContent : '');
                                this.currentRoute = content;
                                this.render(content);
                            }
                            setTimeout(() => { if (window.loadCarrerBot) window.loadCarrerBot(); }, 50);
                        } catch (e) {
                            console.error('Error cargando landing:', e);
                            this.container.innerHTML = '<p>Error cargando landing. <a href="#/">Recargar</a></p>';
                        }
                        return;
                    }
                    if (hash === '/login') {
                        try {
                            if (!isFileProtocol) {
                                const res = await fetch('./pages/login.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                            } else {
                                const content = this.routes['/login'] || '';
                                this.currentRoute = content;
                                this.render(content);
                            }
                            setTimeout(() => { if (window.initLoginForm) window.initLoginForm(); }, 100);
                        } catch (e) {
                            console.error('Error cargando login:', e);
                            this.container.innerHTML = '<p>Error cargando login. <a href="#/">Volver</a></p>';
                        }
                        return;
                    }
                    if (hash === '/register') {
                        try {
                            if (!isFileProtocol) {
                                const res = await fetch('./pages/register.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                            } else {
                                const content = this.routes['/register'] || '';
                                this.currentRoute = content;
                                this.render(content);
                            }
                            setTimeout(() => { if (window.initRegisterForm) window.initRegisterForm(); }, 100);
                        } catch (e) {
                            console.error('Error cargando register:', e);
                            this.container.innerHTML = '<p>Error cargando registro. <a href="#/">Volver</a></p>';
                        }
                        return;
                    }
                } catch (error) {
                    console.error('Error en handleRoute:', error);
                    if (loadingEl) loadingEl.style.display = 'none';
                    try { this.container.innerHTML = '<div class="error">Error cargando la p√°gina</div>'; } catch (_) {}
                }
            }

            render(content) {
                // Ocultar pantalla de carga PRIMERO (est√° fuera de #app, no se destruye)
                const loadingEl = document.getElementById('loadingScreen');
                if (loadingEl) loadingEl.style.display = 'none';

                try {
                    if (!content) {
                        console.warn('No hay contenido para la ruta actual');
                        content = (typeof landingContent !== 'undefined') ? landingContent : '<div class="error">Contenido no disponible</div>';
                    }
                    this.container.innerHTML = content;
                    this.executeScripts();
                } catch (error) {
                    console.error('Error rendering route:', error);
                    this.container.innerHTML = '<div class="error">Error cargando la p√°gina</div>';
                }
            }

            executeScripts() {
                const scripts = this.container.querySelectorAll('script');
                scripts.forEach((script, index) => {
                    try {
                        // Usar eval en lugar de appendChild para evitar problemas con expresiones regulares
                        if (script.textContent) {
                            eval(script.textContent);
                        }
                    } catch (error) {
                        console.error('Error executing script', index, ':', error);
                        console.error('Script content:', script.textContent);
                        // Continuar con los dem√°s scripts
                    }
                });
            }

            requireAuth() {
                const user = localStorage.getItem('user');
                if (!user) {
                    this.navigate('/register');
                    return false;
                }
                return true;
            }

            requirePlan() {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.has_plan) {
                    this.navigate('/onboarding');
                    return false;
                }
                return true;
            }
        }

        // Autenticaci√≥n: usar AuthService (Supabase), sin autenticaci√≥n local
        const router = new Router();
        const auth = new AuthService(window.supabase);
        window.planService = new PlanService(window.supabase);
        
        // Hacer disponibles globalmente
        window.router = router;
        window.auth = auth;
        
        // IA: sin inicializaci√≥n de AIService (Claude). El n√∫cleo es Groq en backend.

        // Iconos SVG globales
        window.icons = {
            database: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>`,
            code: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>`,
            zap: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
            'trending-up': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`,
            award: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>`,
            'check-circle': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            github: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>`,
            book: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
            lock: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`,
            'chevron-down': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
            'chevron-up': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>`
        };

        // Funciones utilitarias globales
        window.getDifficultyColor = (difficulty) => {
            const colors = {
                easy: 'difficulty-easy',
                medium: 'difficulty-medium',
                hard: 'difficulty-hard'
            };
            return colors[difficulty] || 'difficulty-easy';
        };

        window.getDifficultyLabel = (difficulty) => {
            const labels = {
                easy: 'üü¢ F√°cil',
                medium: 'üü° Medio',
                hard: 'üî¥ Dif√≠cil'
            };
            return labels[difficulty] || difficulty;
        };

        window.getPhaseColor = (color) => {
            const colorMap = {
                'bg-blue-500': 'text-blue',
                'bg-green-500': 'text-green',
                'bg-purple-500': 'text-purple',
                'bg-orange-500': 'text-orange',
                'bg-red-500': 'text-red'
            };
            return colorMap[color] || 'text-blue';
        };

        window.showNotification = (message, type = 'info', duration = 3000) => {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        };

        // Funciones globales para templates
        window.scrollToFeatures = function() {
            const el = document.getElementById('features');
            if (el) el.scrollIntoView({ behavior: 'smooth' });
        };

        // Cargar CarrerBot en landing (se ejecuta despu√©s del render)
        window.loadCarrerBot = function(){
            const mount = document.getElementById('carrerbotMount');
            if (!mount) return;
            const isFileProtocol = window.location.protocol === 'file:';
            if (isFileProtocol) {
                mount.innerHTML = '<div class="carrerbot-hero"><img src="carrerbot/carrerbotdashboard.png" alt="CarrerBot" class="carrerbot-hero-img"></div>';
                mount.classList.add('carrerbot--greet');
                return;
            }
            fetch('components/carrerbot.html')
                .then(r => r.text())
                .then(html => {
                    mount.innerHTML = html;
                    mount.classList.add('carrerbot--greet');
                })
                .catch(() => console.warn('No se pudo cargar CarrerBot'));
        };

        // generatePlan eliminado: la generaci√≥n ocurre en onboarding v√≠a backend Groq.

        // initDashboard eliminado: el dashboard usa loadDashboard + una card (sin fases hardcodeadas).
        // La vista limpia no tiene phasesContainer; el plan se muestra en planCardContainer.

        window.logout = function() {
            window.auth.logout();
            window.router.navigate('/');
        };

        window.initRegisterForm = function() {
            const form = document.getElementById('registerForm');
            if (!form) return;
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submitBtn');
                
                // Evitar m√∫ltiples submits
                if (submitBtn.disabled) {
                    console.log('‚è≥ El formulario ya est√° siendo procesado...');
                    return;
                }
                
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Registrando...';
                
                const formData = new FormData(form);
                const name = formData.get('name');
                const email = formData.get('email');
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');

                if (password !== confirmPassword) {
                    window.showNotification('Las contrase√±as no coinciden', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                if (!name || !email || !password) {
                    window.showNotification('Por favor completa todos los campos', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                try {
                    console.log('üîÑ Iniciando registro para:', email);
                    
                    // Verificar que Supabase est√° configurado
                    if (!window.supabase.isConfigured) {
                        console.error('‚ùå Supabase no est√° configurado');
                        window.showNotification('‚ö†Ô∏è Supabase no est√° configurado. Configura variables de entorno VITE_SUPABASE_URL y VITE_SUPABASE_ANON_KEY', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    
                    console.log('‚úÖ Supabase est√° configurado');
                    
                    // Primero registrar en Supabase Auth
                    console.log('üìù Registrando en Supabase Auth...');
                    const authResult = await window.supabase.signUp(email, password);
                    
                    if (!authResult.success) {
                        console.error('‚ùå Error en Supabase Auth:', authResult.error);
                        
                        // Mensaje especial para rate limiting
                        if (authResult.retryAfter) {
                            const minutes = Math.ceil(authResult.retryAfter / 60);
                            window.showNotification(`‚è≥ Demasiados intentos. Por favor espera ${minutes} minuto(s) antes de intentar nuevamente.`, 'error', 8000);
                            // Deshabilitar bot√≥n temporalmente
                            submitBtn.disabled = true;
                            submitBtn.textContent = `Reintenta en ${minutes}m`;
                            setTimeout(() => {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }, authResult.retryAfter * 1000);
                        } else if (authResult.error && authResult.error.includes('ya est√° registrado')) {
                            // Usuario ya existe
                            window.showNotification('Este email ya est√° registrado. Por favor inicia sesi√≥n.', 'error', 6000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            // Mostrar opci√≥n de ir a login
                            setTimeout(() => {
                                const goLogin = confirm('¬øDeseas ir a la p√°gina de inicio de sesi√≥n?');
                                if (goLogin) {
                                    window.router.navigate('/login');
                                }
                            }, 1000);
                        } else if (authResult.error && authResult.error.includes('email')) {
                            window.showNotification('‚ö†Ô∏è Problema con el email. Verifica que sea un email v√°lido.', 'error', 6000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        } else {
                            window.showNotification(authResult.error || 'Error al registrar', 'error');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                        
                        return;
                    }

                    const userId = authResult.user.id;
                    console.log('‚úÖ Usuario creado en Auth con ID:', userId);
                    
                    // Verificar si requiere confirmaci√≥n de email
                    if (authResult.needsEmailConfirmation) {
                        console.log('üìß Se envi√≥ confirmaci√≥n de email. El usuario necesita verificar su email.');
                        window.showNotification('¬°Cuenta registrada! Por favor verifica tu email para confirmar tu cuenta.', 'success', 5000);
                        setTimeout(() => {
                            window.router.navigate('/login');
                        }, 5000);
                        return;
                    }

                    // Luego crear el registro en tabla users (solo si no requiere confirmaci√≥n)
                    console.log('üì§ Insertando en tabla users...');
                    const userResult = await window.supabase.post('users', {
                        id: userId,
                        email: email,
                        name: name,
                        password_hash: 'managed_by_supabase_auth',
                        role: 'user',
                        has_plan: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                    if (!userResult.success) {
                        console.error('‚ùå Error al insertar en tabla users:', userResult.error);
                        window.showNotification('Cuenta registrada en Auth pero error al guardar perfil. Error: ' + userResult.error, 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }

                    console.log('‚úÖ Usuario insertado en tabla users');

                    // üîë AUTO-LOGIN AUTOM√ÅTICO DESPU√âS DEL REGISTRO
                    console.log('üîê Iniciando auto-login autom√°tico...');
                    const autoLoginResult = await window.supabase.signIn(email, password);
                    
                    if (!autoLoginResult.success) {
                        console.error('‚ùå Error en auto-login:', autoLoginResult.error);
                        window.showNotification('Cuenta creada pero error en auto-login. Por favor inicia sesi√≥n.', 'warning');
                        setTimeout(() => {
                            window.router.navigate('/login');
                        }, 1500);
                        return;
                    }
                    
                    // Guardar usuario en localStorage tambi√©n (para modo offline)
                    await window.auth.loadCurrentUser();
                    
                    // Marcar que viene desde REGISTER (para validar en onboarding)
                    sessionStorage.setItem('fromRegister', 'true');
                    console.log('‚úÖ Bandera de REGISTER establecida para onboarding');
                    
                    console.log('‚úÖ Auto-login completado, usuario autenticado');
                    console.log('‚úÖ Registro completado exitosamente');
                    window.showNotification('¬°Cuenta creada exitosamente!', 'success');
                    
                    // üëâ REDIRIGIR A ONBOARDING (NO al dashboard)
                    setTimeout(() => {
                        window.router.navigate('/onboarding');
                    }, 1500);
                } catch (error) {
                    console.error('‚ùå Error en registro:', error);
                    window.showNotification('Error al crear la cuenta. Intenta nuevamente. Error: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        };

        window.initLoginForm = function() {
            const form = document.getElementById('loginForm');
            if (!form) return;
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = form.querySelector('button[type="submit"]');
                
                // Evitar m√∫ltiples submits
                if (submitBtn.disabled) {
                    console.log('‚è≥ El formulario ya est√° siendo procesado...');
                    return;
                }
                
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Iniciando sesi√≥n...';
                
                const formData = new FormData(form);
                const email = formData.get('email');
                const password = formData.get('password');

                if (!email || !password) {
                    window.showNotification('Por favor completa todos los campos', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                try {
                    console.log('üîÑ Iniciando sesi√≥n para:', email);
                    
                    let loginSuccess = false;
                    
                    // Intentar con Supabase primero si est√° configurado
                    if (window.supabase && window.supabase.isConfigured) {
                        console.log('üìù Iniciando sesi√≥n en Supabase Auth...');
                        const authResult = await window.supabase.signIn(email, password);
                        
                        if (authResult.success) {
                            loginSuccess = true;
                        }
                    }
                    
                    if (loginSuccess) {
                        await window.auth.loadCurrentUser();
                        console.log('‚úÖ Sesi√≥n completada exitosamente');
                        window.showNotification('¬°Bienvenido!', 'success');
                        
                        // ÔøΩ LOGIN VA DIRECTO A DASHBOARD
                        setTimeout(() => {
                            window.router.navigate('/dashboard');
                        }, 1500);
                    } else {
                        console.error('‚ùå Email o contrase√±a incorrectos');
                        window.showNotification('Email o contrase√±a incorrectos', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                } catch (error) {
                    console.error('‚ùå Error en inicio de sesi√≥n:', error);
                    window.showNotification('Error al iniciar sesi√≥n. Intenta nuevamente. Error: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        };

        // Contenido de las p√°ginas (inline para evitar CORS)
        const landingContent = `
<div class="landing-page">
    <div class="landing-header-bubble">
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-logo">
                    <h3>Plan Carrera Pro</h3>
                </div>
                <div class="navbar-buttons">
                    <button class="btn-outline" data-route="/login">
                        Iniciar Sesi√≥n
                    </button>
                    <button class="btn-primary" data-route="/register">
                        Registrarse
                    </button>
                </div>
            </div>
        </nav>
        <section class="hero">
            <div class="landing-hero-grid">
                <div class="hero-content">
                    <h1 class="hero-title">
                        Crea tu <span class="gradient-text">Plan de Carrera</span> con IA
                    </h1>
                    <p class="hero-subtitle">
                        Transforma tu futuro profesional con un plan personalizado generado por Groq AI.
                        Aprende las habilidades que el mercado realmente necesita.
                    </p>
                    <div class="hero-cta">
                        <button class="btn-primary" data-route="/register">
                            Registrarse
                        </button>
                        <button class="btn-secondary" onclick="window.scrollToFeatures()">
                            Ver Caracter√≠sticas
                        </button>
                    </div>
                </div>
                <div class="hero-visual">
                    <div id="carrerbotMount" class="carrerbot-container carrerbot--hero"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Features Section -->
    <section class="features" id="features">
        <div class="container">
            <h2 class="section-title">Caracter√≠sticas Principales</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">ü§ñ</div>
                    <h3>Chat IA Integrado</h3>
                    <p>Chatea con Groq AI para resolver dudas, recibir consejos y personalizar tu aprendizaje.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <h3>Proyectos Personalizados</h3>
                    <p>Genera proyectos √∫nicos basados en tus intereses, nivel y objetivos profesionales.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>GitHub Tracking</h3>
                    <p>Integra tu progreso directamente con GitHub y construye tu portfolio profesional.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Plan Carrera Pro</h4>
                    <p>El futuro del aprendizaje tecnol√≥gico impulsado por IA.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Plan Carrera Pro. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
</div>
        `;

        const registerContent = `
<div class="register-page">
  <div class="register-container">
    <div class="floating-card card animate-fade-in">
      <div class="text-center mb-6">
        <h1 class="text-gradient text-3xl font-bold mb-2">Crear Cuenta</h1>
        <p class="text-gray-600">√önete a miles de profesionales aprendiendo con IA</p>
      </div>
      <form class="register-form" id="registerForm">
        <div class="form-group">
          <label for="name" class="form-label">Nombre Completo</label>
          <input type="text" id="name" name="name" required placeholder="Juan P√©rez" class="input">
        </div>
        <div class="form-group">
          <label for="email" class="form-label">Correo Electr√≥nico</label>
          <input type="email" id="email" name="email" required placeholder="juan@ejemplo.com" class="input">
        </div>
        <div class="form-group">
          <label for="password" class="form-label">Contrase√±a</label>
          <input type="password" id="password" name="password" required placeholder="M√≠nimo 6 caracteres" class="input">
          <div class="text-sm mt-2" id="passwordStrength"></div>
        </div>
        <div class="form-group">
          <label for="confirmPassword" class="form-label">Confirmar Contrase√±a</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Repite tu contrase√±a" class="input">
        </div>
        <button type="submit" class="btn btn-primary btn-block" id="submitBtn">Crear Cuenta</button>
        <div class="form-footer mt-6 text-center">
          <p class="text-gray-600">¬øYa tienes cuenta? <a href="#/login" class="text-primary" data-route="/login">Inicia sesi√≥n</a></p>
        </div>
      </form>
    </div>
    <div class="floating-card card animate-fade-in" style="animation-delay: 0.2s;">
      <h2 class="text-gray-800 text-2xl font-semibold text-center mb-8">¬øPor qu√© registrarte?</h2>
      <div class="space-y-6">
        <div class="card hover-lift">
          <div class="flex items-center gap-4">
            <div class="text-4xl w-16 h-16 bg-primary-100 rounded-2xl flex items-center justify-center">üéØ</div>
            <div>
              <h3 class="text-gray-800 text-lg font-semibold mb-1">Plan Personalizado</h3>
              <p class="text-gray-600 text-sm">IA crea un plan √∫nico basado en tus objetivos</p>
            </div>
          </div>
        </div>
        <div class="card hover-lift">
          <div class="flex items-center gap-4">
            <div class="text-4xl w-16 h-16 bg-secondary-100 rounded-2xl flex items-center justify-center">ü§ñ</div>
            <div>
              <h3 class="text-gray-800 text-lg font-semibold mb-1">Chat con Claude</h3>
              <p class="text-gray-600 text-sm">Asistencia 24/7 para resolver dudas</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  var form = document.getElementById('registerForm');
  var pwd = document.getElementById('password');
  var confirm = document.getElementById('confirmPassword');
  var strengthEl = document.getElementById('passwordStrength');
  if (pwd && strengthEl) {
    pwd.addEventListener('input', function(){
      var v = pwd.value, s = 0;
      if (v.length >= 6) s++;
      if (v.length >= 10) s++;
      if (/[a-z]/.test(v) && /[A-Z]/.test(v)) s++;
      if (/[0-9]/.test(v)) s++;
      if (/[^a-zA-Z0-9]/.test(v)) s++;
      var msg = s <= 1 ? 'D√©bil' : s <= 3 ? 'Media' : 'Fuerte';
      strengthEl.textContent = 'Fortaleza: ' + msg;
    });
  }
  if (confirm) {
    confirm.addEventListener('input', function(){
      if (pwd.value && confirm.value && pwd.value !== confirm.value) {
        confirm.setCustomValidity('Las contrase√±as no coinciden');
      } else {
        confirm.setCustomValidity('');
      }
    });
  }
  if (form) {
    form.addEventListener('submit', function(e){
      e.preventDefault();
      if (pwd.value !== confirm.value) {
        if (typeof showNotification === 'function') showNotification('Las contrase√±as no coinciden', 'error');
        return;
      }
      var userData = { name: document.getElementById('name').value, email: document.getElementById('email').value, password: pwd.value };
      var users = JSON.parse(localStorage.getItem('users') || '[]');
      users.push(userData);
      localStorage.setItem('users', JSON.stringify(users));
      localStorage.setItem('currentUser', JSON.stringify(userData));
      if (typeof showNotification === 'function') showNotification('Cuenta creada', 'success');
      setTimeout(function(){ router.navigate('/onboarding'); }, 300);
    });
  }
})();
<\/script>
        `;

        const loginContent = `
<div class="login-page">
  <div class="login-container">
    <div class="floating-card card animate-fade-in">
      <h1 class="text-gradient text-3xl font-bold mb-2">Iniciar Sesi√≥n</h1>
      <p class="text-gray-600 mb-6">Bienvenido de vuelta a Plan Carrera Pro</p>
      <form id="loginForm" class="mb-6">
        <div class="form-group">
          <label for="loginEmail" class="form-label">Email</label>
          <input type="email" id="loginEmail" name="email" placeholder="tu@email.com" class="input" required>
        </div>
        <div class="form-group">
          <label for="loginPassword" class="form-label">Contrase√±a</label>
          <input type="password" id="loginPassword" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">Iniciar Sesi√≥n</button>
      </form>
      <div class="mb-6 text-center">
        <span class="text-gray-500">¬øNo tienes cuenta?</span>
      </div>
      <button class="btn btn-secondary btn-block" data-route="/register">Crear cuenta nueva</button>
    </div>
  </div>
</div>
<script>
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var email = document.getElementById('loginEmail').value;
  var password = document.getElementById('loginPassword').value;
  if (!email || !password) { alert('Por favor completa todos los campos'); return; }
  var users = JSON.parse(localStorage.getItem('users') || '[]');
  var user = users.find(function(u){ return u.email === email && u.password === password; });
  if (user) {
    localStorage.setItem('currentUser', JSON.stringify(user));
    if (typeof showNotification === 'function') showNotification('¬°Bienvenido!', 'success');
    setTimeout(function(){ router.navigate('/dashboard'); }, 300);
  } else {
    if (typeof showNotification === 'function') showNotification('Email o contrase√±a incorrectos', 'error');
  }
});
<\/script>
        `;

        const onboardingContent = `
<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../css/onboarding.css">
<div class="onboarding-page">
    <div class="onboarding-chat-wrapper">
        <div class="chat-container card animate-fade-in" id="onboardingChatCard">
            <!-- Header igual que el sidebar del dashboard: Groq AI + En l√≠nea -->
            <header class="chat-header">
                <div class="flex items-center gap-3">
                    <div class="avatar relative">
                        <div class="avatar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" class="chat-icon"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <span class="status-indicator"></span>
                    </div>
                    <div>
                        <h2 class="text-white text-lg font-semibold m-0">Groq AI</h2>
                        <span class="text-white opacity-90 text-sm">En l√≠nea ¬∑ ¬øCu√°l ser√° tu plan?</span>
                    </div>
                </div>
            </header>

            <!-- Cuerpo del chat: mismo markup que el sidebar del dashboard -->
            <div class="p-6 overflow-y-auto custom-scrollbar" id="onboardingMessages">
                <div class="mb-4" data-role="assistant">
                    <div class="card bg-gray-100 p-4 rounded-xl soft-shadow" style="border-bottom-left-radius: 0.25rem; max-width: 80%;">
                        <p class="text-gray-800 text-sm mb-2">¬øQu√© te gustar√≠a aprender? Cu√©ntame y te ayudo a definir tu camino.</p>
                        <p class="text-gray-600 text-sm">Por ejemplo: SQL, Python, ciencia de datos, desarrollo web, machine learning‚Ä¶</p>
                    </div>
                </div>
                <div class="p-4 flex flex-wrap gap-2" id="onboardingQuickQuestions">
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero aprender Python">Quiero aprender Python</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero aprender SQL y an√°lisis de datos">SQL y an√°lisis de datos</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero ser desarrollador web">Desarrollador web</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero hacer ciencia de datos y ML">Ciencia de datos y ML</button>
                </div>
                <div class="p-4 text-center text-gray-500 text-sm" id="onboardingTyping" style="display: none;">
                    <div class="animate-spin w-5 h-5 border-2 border-gray-300 border-t-primary-500 rounded-full mx-auto mb-2"></div>
                    <span>Groq est√° escribiendo‚Ä¶</span>
                </div>
                <div class="chat-input-container p-4 border-t border-gray-200">
                    <input type="text" class="input" id="onboardingUserInput" placeholder="Escribe tu mensaje‚Ä¶" autocomplete="off" />
                    <button type="button" class="btn btn-primary rounded-xl" id="onboardingSendChatBtn" title="Enviar" aria-label="Enviar">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <button type="button" class="btn btn-primary btn-block" id="onboardingGeneratePlanBtn">Generar mi plan con Groq</button>
                </div>
            </div>

            <!-- Estado: generando -->
            <div class="onboarding-loading-state card p-12 text-center" id="loadingState" style="display: none; padding: 3rem; text-align: center; background: white;">
                <div class="loading-content">
                    <div class="animate-spin w-12 h-12 border-3 border-gray-200 border-t-primary-500 rounded-full mx-auto mb-4"></div>
                    <h3 style="color: var(--gray-800); font-size: var(--font-size-xl); margin-bottom: 0.5rem; font-weight: 600;">Creando tu plan personalizado</h3>
                    <p style="color: var(--gray-600); font-size: var(--font-size-base);">Groq est√° dise√±ando tu plan de carrera.</p>
                </div>
            </div>

            <!-- Estado: √©xito ‚Üí ir al dashboard -->
            <div class="onboarding-results-state card p-12 text-center" id="resultsState">
                <div class="results-content">
                    <div class="success-icon" style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2 style="color: var(--gray-800); font-size: var(--font-size-2xl); margin-bottom: 1rem; font-weight: 600;">Plan generado</h2>
                    <p class="onboarding-plan-title" id="planTitle" style="color: var(--gray-600); font-size: var(--font-size-lg); margin-bottom: 2rem;"></p>
                    <button type="button" class="btn-primary btn-large soft-ui-button" id="goToDashboardBtn" style="padding: 1rem 2rem; font-size: var(--font-size-lg);">
                        Ver mi Dashboard
                    </button>
                </div>
            </div>

            <!-- Estado: error -->
            <div class="onboarding-error-state card p-12 text-center" id="errorState">
                <div class="error-content">
                    <p id="errorMessage" style="color: var(--gray-700); font-size: var(--font-size-base); margin-bottom: 1.5rem;"></p>
                    <button type="button" class="btn-primary soft-ui-button" id="retryBtn">Intentar de nuevo</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var API_BASE = typeof window.API_BASE_URL !== 'undefined' ? window.API_BASE_URL : '';
    var WELCOME_GROQ = '¬øQu√© te gustar√≠a aprender? Por ejemplo: SQL, Python, ciencia de datos, desarrollo web, machine learning‚Ä¶';

    var chatState = {
        messages: [{ role: 'assistant', content: WELCOME_GROQ }],
        loading: false
    };

    function showState(state) {
        var chatEl = document.getElementById('onboardingChatCard');
        var loadingEl = document.getElementById('loadingState');
        var resultsEl = document.getElementById('resultsState');
        var errorEl = document.getElementById('errorState');
        [chatEl, loadingEl, resultsEl, errorEl].forEach(function(el) {
            if (el) el.style.display = 'none';
        });
        if (state === 'chat' && chatEl) chatEl.style.display = 'block';
        if (state === 'loading' && loadingEl) loadingEl.style.display = 'block';
        if (state === 'results' && resultsEl) resultsEl.style.display = 'block';
        if (state === 'error' && errorEl) errorEl.style.display = 'block';
    }

    function escapeHtml(text) {
        if (text == null) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    function nl2br(text) {
        return escapeHtml(text || '').replace(/\n/g, '<br>');
    }

    /** Renderiza mensajes con la misma estructura que el chatbot del dashboard (chatbot-msg, chatbot-msg-content) */
    function renderOnboardingMessages() {
        var container = document.getElementById('onboardingMessages');
        if (!container) return;
        container.innerHTML = '';
        chatState.messages.forEach(function(msg) {
            var div = document.createElement('div');
            div.className = 'chatbot-msg chatbot-msg-' + msg.role;
            div.setAttribute('data-role', msg.role);
            var isAssistant = msg.role === 'assistant';
            var content = isAssistant ? nl2br(msg.content) : escapeHtml(msg.content);
            div.innerHTML = '<div class="chatbot-msg-content">' + (isAssistant ? '<p>' + content + '</p>' : '<p>' + content + '</p>') + '</div>';
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
        var qq = document.getElementById('onboardingQuickQuestions');
        if (qq) qq.style.display = chatState.messages.length <= 1 ? 'flex' : 'none';
    }

    function setChatLoading(loading) {
        chatState.loading = loading;
        var typingEl = document.getElementById('onboardingTyping');
        if (typingEl) typingEl.style.display = loading ? 'flex' : 'none';
        if (loading) {
            var messages = document.getElementById('onboardingMessages');
            if (messages) messages.scrollTop = messages.scrollHeight;
        }
    }

    /** Env√≠a mensaje a Groq (misma l√≥gica que el sidebar: POST /chat/message) */
    function sendChatMessage(text) {
        var msg = (text || '').trim();
        if (!msg || chatState.loading) {
            console.log('Mensaje vac√≠o o en estado de carga:', { msg: msg, loading: chatState.loading });
            return;
        }

        console.log('Enviando mensaje:', msg);
        chatState.messages.push({ role: 'user', content: msg });
        renderOnboardingMessages();
        setChatLoading(true);

        function done(responseText) {
            chatState.messages.push({ role: 'assistant', content: responseText });
            renderOnboardingMessages();
            setChatLoading(false);
        }
        function fail(errMsg) {
            chatState.messages.push({ role: 'assistant', content: errMsg || 'No pude procesar tu mensaje. Int√©ntalo de nuevo.' });
            renderOnboardingMessages();
            setChatLoading(false);
        }

        if (!API_BASE) {
            console.error('API_BASE no configurado:', API_BASE);
            fail('Backend no configurado (API_BASE_URL). Configura el servidor para usar Groq.');
            return;
        }

        console.log('Haciendo fetch a:', API_BASE + '/chat/message');
        fetch(API_BASE + '/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
        })
            .then(function(res) {
                console.log('Respuesta del servidor:', res.status, res.ok);
                return res.json().then(function(data) {
                    if (!res.ok) {
                        var detail = data.detail;
                        var msg = typeof detail === 'string' ? detail : (Array.isArray(detail) ? (detail[0] && detail[0].msg) || JSON.stringify(detail) : 'Error ' + res.status);
                        throw new Error(msg || 'Error en el servidor');
                    }
                    return data;
                }).catch(function(e) {
                    if (e instanceof Error && e.message) throw e;
                    throw new Error('Error ' + res.status);
                });
            })
            .then(function(data) {
                console.log('Datos recibidos:', data);
                done(data.message || 'Sin respuesta');
            })
            .catch(function(err) {
                console.error('Onboarding chat (Groq):', err);
                fail(err && err.message ? err.message : 'No se pudo conectar. ¬øEst√° el backend en ' + API_BASE + '?');
            });
    }

    function savePlanAndUser(planPayload) {
        var raw = planPayload.generated_plan || planPayload.plan_content || planPayload;
        var planContent = typeof raw === 'string' ? (function() { try { return JSON.parse(raw); } catch (e) { return raw; } })() : raw;
        var supaUser = window.supabase && window.supabase.getCurrentUser ? window.supabase.getCurrentUser() : null;
        if (!supaUser || !supaUser.id) {
            console.error('Usuario Supabase no disponible para guardar plan');
            return;
        }
        if (typeof planService === 'undefined' || !planService || !planService.savePlan) {
            console.error('PlanService no disponible');
            return;
        }
        planService.savePlan(supaUser.id, planContent, { source: 'onboarding-chat' })
            .then(function(res) {
                if (!res || !res.success) {
                    throw new Error('Error al guardar el plan en Supabase');
                }
                console.log('Plan guardado en Supabase con id:', res.plan.id);
                window.auth && window.auth.markOnboardingComplete(supaUser.id);
            })
            .catch(function(err) {
                console.error('Error guardando plan en Supabase:', err);
            });
    }

    function goToDashboard() {
        sessionStorage.removeItem('fromRegister');
        sessionStorage.removeItem('creatingNewPlan');
        if (window.router) window.router.navigate('/dashboard');
        else if (window.location.hash) window.location.hash = '#/dashboard';
        else window.location.href = 'index.html#/dashboard';
    }

    /** Genera el plan con Groq (POST /ai/generate-plan-from-chat) usando el √∫ltimo mensaje del usuario o todos */
    function generatePlanFromConversation() {
        var userMessages = chatState.messages.filter(function(m) { return m.role === 'user'; }).map(function(m) { return m.content; });
        var messageToSend = userMessages.length > 0 ? (userMessages.length === 1 ? userMessages[0] : userMessages.join(' | ')) : '';
        if (!messageToSend.trim()) {
            if (window.showNotification) window.showNotification('Escribe al menos un mensaje sobre qu√© quieres estudiar antes de generar el plan.', 'warning');
            else alert('Escribe al menos un mensaje sobre qu√© quieres estudiar antes de generar el plan.');
            return;
        }

        showState('loading');
        function onError(err) {
            console.error('Error generando plan:', err);
            showState('error');
            var errMsg = document.getElementById('errorMessage');
            if (errMsg) errMsg.textContent = (err && err.message) || (typeof err === 'string' ? err : 'No se pudo generar el plan.');
        }

        if (!API_BASE) {
            onError(new Error('Backend no configurado (API_BASE_URL).'));
            return;
        }

        fetch(API_BASE + '/ai/generate-plan-from-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageToSend })
        })
            .then(function(res) {
                return res.json().then(function(data) {
                    if (!res.ok) {
                        var d = data.detail || data.message;
                        throw new Error(typeof d === 'string' ? d : (Array.isArray(d) ? (d[0] && d[0].msg) || JSON.stringify(d) : 'Error ' + res.status));
                    }
                    return data;
                });
            })
            .then(function(data) {
                savePlanAndUser(data);
                var titleEl = document.getElementById('planTitle');
                if (titleEl) titleEl.textContent = data.title || 'Tu plan de carrera';
                showState('results');
            })
            .catch(onError);
    }

    function initOnboarding() {
        var auth = window.auth;
        // Sin autenticaci√≥n de rutas: permitir acceso directo a onboarding.

        chatState.messages = [{ role: 'assistant', content: WELCOME_GROQ }];
        chatState.loading = false;
        showState('chat');
        renderOnboardingMessages();

        var input = document.getElementById('onboardingUserInput');
        var sendChatBtn = document.getElementById('onboardingSendChatBtn');
        var generatePlanBtn = document.getElementById('onboardingGeneratePlanBtn');
        var goBtn = document.getElementById('goToDashboardBtn');
        var retryBtn = document.getElementById('retryBtn');

        console.log('Elementos encontrados:', {
            input: !!input,
            sendChatBtn: !!sendChatBtn,
            generatePlanBtn: !!generatePlanBtn,
            goBtn: !!goBtn,
            retryBtn: !!retryBtn
        });

        if (sendChatBtn && input) {
            console.log('Asignando evento click al bot√≥n de enviar');
            sendChatBtn.addEventListener('click', function(e) {
                console.log('Bot√≥n de enviar clickeado');
                e.preventDefault();
                var message = input.value.trim();
                if (message) {
                    sendChatMessage(message);
                    input.value = '';
                } else {
                    console.log('Mensaje vac√≠o, no se env√≠a');
                }
            });
        } else {
            console.log('No se encontraron elementos para asignar evento:', { sendChatBtn: !!sendChatBtn, input: !!input });
        }
        if (input) {
            console.log('Asignando evento keydown al input');
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    console.log('Tecla Enter presionada');
                    e.preventDefault();
                    var message = input.value.trim();
                    if (message) {
                        sendChatMessage(message);
                        input.value = '';
                    } else {
                        console.log('Mensaje vac√≠o, no se env√≠a');
                    }
                }
            });
        }
        if (generatePlanBtn) generatePlanBtn.addEventListener('click', generatePlanFromConversation);
        if (goBtn) goBtn.addEventListener('click', goToDashboard);
        if (retryBtn) retryBtn.addEventListener('click', function() { showState('chat'); });

        var quickQuestions = document.getElementById('onboardingQuickQuestions');
        if (quickQuestions) {
            quickQuestions.querySelectorAll('.btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var q = this.getAttribute('data-question');
                    if (q) { sendChatMessage(q); }
                });
            });
        }
    }

    window.initOnboarding = initOnboarding;
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initOnboarding);
    } else {
        initOnboarding();
    }
})();
<\/script>
        `;

        const dashboardContent = `
<div class="dashboard-page">
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="dashboard-title">Hola, <span id="userName">Usuario</span></h1>
                <p class="dashboard-subtitle">Tu plan de carrera</p>
            </div>
            <div class="header-right">
                <button type="button" class="btn-secondary" onclick="logout()">Cerrar sesi√≥n</button>
            </div>
        </div>
    </header>
    <main class="dashboard-main">
        <section class="plan-card-section" id="planCardSection" style="display:none;"><div id="planCardContainer"></div></section>
        <section class="empty-state" id="emptyState">
            <div class="empty-content">
                <p class="empty-message">A√∫n no tienes un Plan de Carrera creado.</p>
                <p class="empty-hint">Cu√©ntanos qu√© quieres estudiar en el onboarding y Groq dise√±ar√° tu plan de carrera.</p>
                <a href="#/onboarding" class="btn-primary" data-route="/onboarding" style="margin-top: 1rem; display: inline-block;">Nuevo plan Carrera</a>
            </div>
        </section>
        <div class="loading-state" id="loadingState" style="display:none;"><div class="loading-content"><div class="loading-spinner"></div><p>Cargando...</p></div></div>
        <div class="error-state" id="errorState" style="display:none;"><div class="error-content"><p id="errorMessage"></p><button type="button" class="btn-primary" onclick="loadDashboard()">Reintentar</button></div></div>
    </main>
    <div id="chatbotSidebarRoot">
      <div class="chatbot-sidebar-overlay" id="chatbotOverlay" aria-hidden="true"></div>
      <aside class="chatbot-sidebar-panel" id="chatbotSidebar" aria-hidden="true">
        <header class="chatbot-sidebar-header">
          <div class="chatbot-sidebar-header-left">
            <div class="chatbot-avatar-wrap">
              <div class="chatbot-avatar"><svg class="chatbot-avatar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
              <span class="chatbot-avatar-online"></span>
            </div>
            <div><h2 class="chatbot-sidebar-title">Groq AI</h2><span class="chatbot-sidebar-status">En l√≠nea</span></div>
          </div>
          <div class="chatbot-sidebar-header-actions">
            <button type="button" class="chatbot-sidebar-btn-icon" id="chatbotBtnMinimize" title="Minimizar" aria-label="Minimizar"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 4v16M16 4v16"/><line x1="4" y1="8" x2="4" y2="16"/><line x1="20" y1="8" x2="20" y2="16"/></svg></button>
            <button type="button" class="chatbot-sidebar-btn-icon" id="chatbotBtnClose" title="Cerrar" aria-label="Cerrar"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
          </div>
        </header>
        <div class="chatbot-sidebar-minimized" id="chatbotMinimizedView" style="display:none;"><button type="button" class="chatbot-sidebar-btn-maximize" id="chatbotBtnMaximize" title="Expandir"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg> Abrir chat</button></div>
        <div class="chatbot-sidebar-body" id="chatbotSidebarBody">
          <div class="chatbot-sidebar-messages" id="chatbotMessages">
            <div class="chatbot-msg chatbot-msg-assistant" data-role="assistant">
              <div class="chatbot-msg-content">
                <div class="carrerbot-container" id="carrerbotMount">
                  <div class="carrerbot-hero" aria-hidden="true">
                    <img src="carrerbot/carrerbotdashboard.png" alt="CarrerBot" class="carrerbot-hero-img">
                  </div>
                </div>
                <p>¬°Hola! üëã Soy tu mentor (Groq AI).</p><p>¬øEn qu√© puedo ayudarte hoy? Puedo:</p><ul><li>Resolver dudas sobre tu plan de carrera</li><li>Explicar conceptos t√©cnicos</li><li>Revisar tu c√≥digo</li><li>Sugerir recursos de aprendizaje</li><li>Motivarte en tu proceso üí™</li></ul>
              </div>
            </div>
          </div>
          <div class="chatbot-quick-questions" id="chatbotQuickQuestions">
            <button type="button" class="chatbot-quick-btn" data-question="¬øC√≥mo va mi progreso?">¬øC√≥mo va mi progreso?</button>
            <button type="button" class="chatbot-quick-btn" data-question="Dame un consejo para hoy">Dame un consejo para hoy</button>
            <button type="button" class="chatbot-quick-btn" data-question="Expl√≠came un concepto de mi fase actual">Expl√≠came un concepto de mi fase actual</button>
            <button type="button" class="chatbot-quick-btn" data-question="¬øQu√© proyecto debo hacer ahora?">¬øQu√© proyecto debo hacer ahora?</button>
          </div>
          <div class="chatbot-typing" id="chatbotTyping" style="display:none;"><div class="chatbot-typing-spinner"></div><span>Groq est√° escribiendo...</span></div>
          <div class="chatbot-input-wrap"><input type="text" class="chatbot-input" id="chatbotInput" placeholder="Escribe tu mensaje..." autocomplete="off"/><button type="button" class="chatbot-send-btn" id="chatbotSendBtn" title="Enviar" aria-label="Enviar"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div>
        </div>
      </aside>
      <button type="button" class="chatbot-float-btn" id="chatbotFloatBtn" aria-label="Abrir chat con Groq AI"><span class="chatbot-float-btn-pulse"></span><span class="chatbot-float-btn-inner"><svg class="chatbot-float-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><span class="chatbot-float-badge">!</span></span><span class="chatbot-float-tooltip">Hablar con Groq AI üí¨</span></button>
    </div>
</div>
<script>
var userPlan=null;var currentPlanId=null;
function loadDashboard(){try{var supaUser=window.supabase&&window.supabase.getCurrentUser?window.supabase.getCurrentUser():null;if(!supaUser){router.navigate('/login');return;}document.getElementById('userName').textContent=(supaUser.user_metadata&&supaUser.user_metadata.name)||supaUser.email||'Usuario';document.getElementById('loadingState').style.display='block';document.getElementById('planCardSection').style.display='none';document.getElementById('emptyState').style.display='none';document.getElementById('errorState').style.display='none';function finish(plan){userPlan=plan;if(userPlan&&!userPlan.id)userPlan.id='local-'+(userPlan.created_at?new Date(userPlan.created_at).getTime():Date.now());document.getElementById('loadingState').style.display='none';if(userPlan){renderPlanCard();document.getElementById('planCardSection').style.display='block';document.getElementById('emptyState').style.display='none';}else{document.getElementById('planCardSection').style.display='none';document.getElementById('emptyState').style.display='block';}}if(typeof planService!=='undefined'&&planService&&planService.getUserPlans){planService.getUserPlans(supaUser.id).then(function(plans){var p=(plans&&plans.length>0)?plans[0]:null;finish(p);}).catch(function(){var s=localStorage.getItem('currentPlan');if(s)try{finish(JSON.parse(s));}catch(e){finish(null);}else finish(null);});}else{var s=localStorage.getItem('currentPlan');if(s)try{finish(JSON.parse(s));}catch(e){finish(null);}else finish(null);}}catch(e){document.getElementById('loadingState').style.display='none';document.getElementById('errorState').style.display='block';document.getElementById('errorMessage').textContent=e.message;}}
function renderPlanCard(){var c=document.getElementById('planCardContainer');if(!c||!userPlan)return;var d=userPlan.plan_content||userPlan;if(typeof d==='string')try{d=JSON.parse(d);}catch(e){d={};}var title=userPlan.title||d.plan_title||d.title||'Plan de carrera';var desc=userPlan.description||d.description||'';var obj=userPlan.objective||d.objective||'';var totalWeeks=d.total_weeks||userPlan.timeline_weeks;var dl=userPlan.estimated_duration||d.estimatedDuration||d.estimated_duration||(totalWeeks?totalWeeks+' semanas':'');var created=userPlan.created_at?function(iso){try{return new Date(iso).toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});}catch(e){return'';}}(userPlan.created_at):'';var phaseCount=(d.phases&&d.phases.length)||0;var what=desc;if(!what&&d.phases&&d.phases.length>0){var f0=d.phases[0];var t=f0.learning_items||f0.topics||f0.learning_objectives||[];what=t.slice(0,3).join(', ');}var id=userPlan.id||'';function esc(t){if(t==null)return'';var x=document.createElement('div');x.textContent=t;return x.innerHTML;}function escA(t){if(t==null)return'';return String(t).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}c.innerHTML='<article class="plan-career-card" onclick="goToPlanDetail(\\''+escA(id)+'\\')" role="button" tabindex="0"><h2 class="plan-career-card-title">'+esc(title)+'</h2>'+(what?'<p class="plan-career-card-field"><span class="label">Qu√© vas a estudiar</span>'+esc(what)+'</p>':'')+(obj?'<p class="plan-career-card-field"><span class="label">Objetivo principal</span>'+esc(obj)+'</p>':'')+(dl?'<p class="plan-career-card-field"><span class="label">Plazo estimado</span>'+esc(dl)+'</p>':'')+(phaseCount?'<p class="plan-career-card-field"><span class="label">Fases</span>'+phaseCount+' fases</p>':'')+(created?'<p class="plan-career-card-field plan-career-card-date"><span class="label">Fecha de creaci√≥n</span>'+esc(created)+'</p>':'')+'<p class="plan-career-card-cta">Ver detalle del plan ‚Üí</p></article>';}
function goToPlanDetail(planId){currentPlanId=planId;if(router)router.navigate('/dashboard/plan/'+planId);}
function logout(){try{if(auth)auth.logout();if(router)router.navigate('/');}catch(e){if(router)router.navigate('/');}}
if(document.readyState!=='loading'){loadDashboard();if(window.initChatbotSidebar)window.initChatbotSidebar();}else document.addEventListener('DOMContentLoaded',function(){loadDashboard();if(window.initChatbotSidebar)window.initChatbotSidebar();});
</scr` + `ipt>
        `;

        // Definir rutas con contenido inline
        router.addRoute('/', landingContent);
        router.addRoute('/login', loginContent);
        router.addRoute('/register', registerContent);
        router.addRoute('/onboarding', onboardingContent);
        router.addRoute('/dashboard', dashboardContent);
        router.addRoute('/projects', '<div class="loading-state"><div class="loading-content"><div class="loading-spinner"></div><p>Cargando proyectos...</p></div></div>');

        // Ocultar loading y mostrar primera ruta; se ejecuta al final, cuando todo est√° definido
        function hideLoadingScreen() {
            var el = document.getElementById('loadingScreen');
            if (el) el.style.display = 'none';
        }

        // Iniciar ya: rutas est√°n registradas, DOM existe (script est√° al final del body)
        try {
            router.handleRoute();
        } catch (e) {
            console.error('Error al iniciar:', e);
            hideLoadingScreen();
            document.getElementById('app').innerHTML = '<p>No se pudo cargar. <a href="#/">Recargar</a></p>';
        }

        // Respaldo por si load/hashchange se disparan antes: volver a ocultar loading
        window.addEventListener('load', hideLoadingScreen);
        setTimeout(hideLoadingScreen, 1500);
    </script>
    <style>
    /* CarrerBot en chatbot sidebar */
    .chatbot-sidebar .carrerbot-container {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0 16px;
    }

    .chatbot-sidebar .carrerbot-hero {
      width: 72px;
      height: 72px;
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
      animation: carrerbotFloat 3.2s ease-in-out infinite;
      overflow: hidden;
    }

    .chatbot-sidebar .carrerbot-hero-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      pointer-events: none;
    }

    /* CarrerBot en landing (modo archivo) */
    .carrerbot--hero .carrerbot-hero {
      width: 360px;
      height: 360px;
      border-radius: 36px;
      box-shadow: 0 24px 48px rgba(0,0,0,0.18), 0 8px 24px rgba(0,0,0,0.12);
      animation: carrerbotFloat 3.2s ease-in-out infinite;
      overflow: hidden;
    }

    .carrerbot--hero .carrerbot-hero-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      pointer-events: none;
    }

    @keyframes carrerbotFloat {
      0% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
      100% { transform: translateY(0); }
    }
    </style>
</body>
</html>
