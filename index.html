<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v1.0.2 - Fix getCurrentUser method -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Plan Carrera Pro - Crea tu Plan de Carrera con IA</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Inyectar variables de entorno en global -->
    <script>
        // Configuraci√≥n de Supabase
        window.SUPABASE_CONFIG = {
            url: 'https://illzdmhlkhnooykecqkv.supabase.co',
            anonKey: 'sb_publishable_VeO6VB6HFb75x0Nk5_6roQ_Wbt_oxPI'
        };
        
        console.log('üìù Variables de Supabase inyectadas en window.SUPABASE_CONFIG');
    </script>
    
    <!-- Supabase Client -->
    <script src="utils/supabase-client.js"></script>
    
    <!-- AI Service (Claude Integration) -->
    <script src="utils/ai-service.js"></script>
    
    <!-- Plan Service (Database Management) -->
    <script src="utils/plan-service.js"></script>
    
    <!-- Auth Service (Mejorado) -->
    <script src="utils/auth-service.js"></script>
</head>
<body>
    <!-- Pantalla de carga FUERA de #app para que no se destruya al renderizar -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Cargando...</h2>
        </div>
    </div>
    <div id="app"></div>

    <script>
        // Sistema de Routing SPA
        class Router {
            constructor() {
                this.routes = {};
                this.currentRoute = null;
                this.container = document.getElementById('app');
                this.init();
            }

            init() {
                // Escuchar cambios en el hash
                window.addEventListener('hashchange', () => this.handleRoute());
                window.addEventListener('load', () => this.handleRoute());
                
                // Manejar clicks en enlaces
                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-route]')) {
                        e.preventDefault();
                        const route = e.target.getAttribute('data-route');
                        this.navigate(route);
                    }
                });
            }

            addRoute(path, content) {
                this.routes[path] = content;
            }

            navigate(path) {
                window.location.hash = path;
            }

            async handleRoute() {
                const loadingEl = document.getElementById('loadingScreen');
                try {
                    const hash = (window.location.hash || '#/').replace(/^#/, '') || '/';

                    // Ruta din√°mica: vista detalle de plan /dashboard/plan/[planId]
                    if (hash.startsWith('/dashboard/plan/')) {
                        const planId = hash.replace(/^\/dashboard\/plan\//, '').split('/')[0];
                        if (planId) {
                            try {
                                const res = await fetch('./pages/plan-detail.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                                setTimeout(() => {
                                    if (window.loadPlanDetail) window.loadPlanDetail();
                                }, 100);
                            } catch (e) {
                                console.error('Error cargando vista de plan:', e);
                                this.container.innerHTML = '<div class="error">Error cargando el plan. <a href="#/dashboard" data-route="/dashboard">Volver al Dashboard</a></div>';
                            }
                        }
                        return;
                    }
                    // Compatibilidad: /dashboard/plans/[planId]
                    if (hash.startsWith('/dashboard/plans/')) {
                        const planId = hash.replace(/^\/dashboard\/plans\//, '').split('/')[0];
                        if (planId) {
                            try {
                                const res = await fetch('./pages/plan-detail.html');
                                const content = await res.text();
                                this.currentRoute = content;
                                this.render(content);
                                setTimeout(() => {
                                    if (window.loadPlanDetail) window.loadPlanDetail();
                                }, 100);
                            } catch (e) {
                                console.error('Error cargando vista de plan:', e);
                                this.container.innerHTML = '<div class="error">Error cargando el plan. <a href="#/dashboard" data-route="/dashboard">Volver al Dashboard</a></div>';
                            }
                        }
                        return;
                    }

                    // Dashboard: siempre usar contenido limpio (header + card o estado vac√≠o)
                    if (hash === '/dashboard') {
                        const content = this.routes['/dashboard'] || this.routes['/'];
                        this.currentRoute = content;
                        this.render(content);
                        setTimeout(() => {
                            if (window.loadDashboard) window.loadDashboard();
                        }, 100);
                        return;
                    }

                    // Onboarding: cargar desde pages/onboarding.html (mismo flujo de preguntas)
                    if (hash === '/onboarding') {
                        try {
                            const res = await fetch('./pages/onboarding.html');
                            const content = await res.text();
                            this.currentRoute = content;
                            this.render(content);
                            setTimeout(() => {
                                if (window.initOnboarding) window.initOnboarding();
                            }, 100);
                        } catch (e) {
                            console.error('Error cargando onboarding:', e);
                            const fallback = this.routes['/onboarding'];
                            this.render(fallback || '<p>Error cargando onboarding.</p>');
                            setTimeout(() => { if (window.initOnboarding) window.initOnboarding(); }, 100);
                        }
                        return;
                    }

                    // Rutas est√°ticas: landing, login, register
                    const content = this.routes[hash] || this.routes['/'];
                    if (content) {
                        this.currentRoute = content;
                        this.render(content);
                        setTimeout(() => {
                            if (hash === '/register' && window.initRegisterForm) window.initRegisterForm();
                            if (hash === '/login' && window.initLoginForm) window.initLoginForm();
                        }, 100);
                    } else {
                        if (typeof landingContent !== 'undefined') {
                            this.currentRoute = landingContent;
                            this.render(landingContent);
                        } else {
                            if (loadingEl) loadingEl.style.display = 'none';
                            this.container.innerHTML = '<p>Ruta no encontrada. <a href="#/">Ir al inicio</a></p>';
                        }
                    }
                } catch (error) {
                    console.error('Error en handleRoute:', error);
                    if (loadingEl) loadingEl.style.display = 'none';
                    try { this.container.innerHTML = '<div class="error">Error cargando la p√°gina</div>'; } catch (_) {}
                }
            }

            render(content) {
                // Ocultar pantalla de carga PRIMERO (est√° fuera de #app, no se destruye)
                const loadingEl = document.getElementById('loadingScreen');
                if (loadingEl) loadingEl.style.display = 'none';

                try {
                    if (!content) {
                        console.warn('No hay contenido para la ruta actual');
                        content = (typeof landingContent !== 'undefined') ? landingContent : '<div class="error">Contenido no disponible</div>';
                    }
                    this.container.innerHTML = content;
                    this.executeScripts();
                } catch (error) {
                    console.error('Error rendering route:', error);
                    this.container.innerHTML = '<div class="error">Error cargando la p√°gina</div>';
                }
            }

            executeScripts() {
                const scripts = this.container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.textContent = script.textContent;
                    document.head.appendChild(newScript);
                    document.head.removeChild(newScript);
                });
            }

            requireAuth() {
                const user = localStorage.getItem('user');
                if (!user) {
                    this.navigate('/register');
                    return false;
                }
                return true;
            }

            requirePlan() {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.has_plan) {
                    this.navigate('/onboarding');
                    return false;
                }
                return true;
            }
        }

        // Sistema de Autenticaci√≥n Local
        class Auth {
            constructor() {
                this.currentUser = null;
                this.init();
            }

            init() {
                const userData = localStorage.getItem('user');
                if (userData) {
                    this.currentUser = JSON.parse(userData);
                }
            }

            register(userData) {
                const user = {
                    id: userData.id || Date.now().toString(),
                    email: userData.email,
                    name: userData.name,
                    password: this.hashPassword(userData.password),
                    createdAt: new Date().toISOString(),
                    has_plan: false,
                    plans: [],  // üÜï Soporte para m√∫ltiples planes
                    plan: null,
                    progress: {
                        completedPhases: [],
                        completedProjects: [],
                        expandedPhases: [1]
                    }
                };

                localStorage.setItem('user', JSON.stringify(user));
                this.currentUser = user;
                return user;
            }

            login(email, password) {
                const userData = localStorage.getItem('user');
                if (!userData) return null;

                const user = JSON.parse(userData);
                if (user.email === email && this.verifyPassword(password, user.password)) {
                    this.currentUser = user;
                    return user;
                }
                return null;
            }

            /**
             * Establece el usuario actual desde login con Supabase (u otra fuente).
             * Guarda en localStorage y actualiza currentUser para que isAuthenticated() sea true.
             */
            setUser(userData) {
                const user = {
                    id: userData.id,
                    email: userData.email,
                    name: userData.name || userData.email,
                    role: userData.role || 'user',
                    has_plan: userData.has_plan || false,
                    plans: userData.plans || [],
                    plan: userData.plan || null,
                    progress: userData.progress || { completedPhases: [], completedProjects: [], expandedPhases: [1] }
                };
                this.currentUser = user;
                localStorage.setItem('user', JSON.stringify(user));
                return user;
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('user');
            }

            updatePlan(plan) {
                if (!this.currentUser) return false;
                
                this.currentUser.has_plan = true;
                this.currentUser.plan = plan;
                localStorage.setItem('user', JSON.stringify(this.currentUser));
                return true;
            }

            updateProgress(progress) {
                if (!this.currentUser) return false;
                
                this.currentUser.progress = { ...this.currentUser.progress, ...progress };
                localStorage.setItem('user', JSON.stringify(this.currentUser));
                return true;
            }

            getUser() {
                return this.currentUser;
            }

            getCurrentUser() {
                return this.currentUser;
            }

            isAuthenticated() {
                return this.currentUser !== null;
            }

            hasPlan() {
                return this.currentUser && this.currentUser.has_plan;
            }

            hashPassword(password) {
                return btoa(password + 'salt');
            }

            verifyPassword(password, hash) {
                return this.hashPassword(password) === hash;
            }
        }

        // Crear instancias globales
        const router = new Router();
        const auth = new Auth();

        // Hacer disponibles globalmente
        window.router = router;
        window.auth = auth;
        
        // Esperar a que AIService se cargue desde ai-service.js
        // Se asignar√° a window.aiService cuando est√© disponible
        let aiServiceReady = false;
        const checkAIService = setInterval(() => {
            if (typeof AIService !== 'undefined' && !aiServiceReady) {
                window.aiService = new AIService();
                aiServiceReady = true;
                console.log('‚úÖ AIService inicializado y disponible globalmente');
                clearInterval(checkAIService);
            }
        }, 100);
        
        // Si no se carga en 5 segundos, registrar error
        setTimeout(() => {
            if (!aiServiceReady) {
                console.error('‚ö†Ô∏è AIService no se carg√≥ despu√©s de 5 segundos');
            }
        }, 5000);

        // Iconos SVG globales
        window.icons = {
            database: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>`,
            code: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>`,
            zap: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
            'trending-up': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`,
            award: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>`,
            'check-circle': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            github: `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>`,
            book: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
            lock: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`,
            'chevron-down': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
            'chevron-up': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>`
        };

        // Funciones utilitarias globales
        window.getDifficultyColor = (difficulty) => {
            const colors = {
                easy: 'difficulty-easy',
                medium: 'difficulty-medium',
                hard: 'difficulty-hard'
            };
            return colors[difficulty] || 'difficulty-easy';
        };

        window.getDifficultyLabel = (difficulty) => {
            const labels = {
                easy: 'üü¢ F√°cil',
                medium: 'üü° Medio',
                hard: 'üî¥ Dif√≠cil'
            };
            return labels[difficulty] || difficulty;
        };

        window.getPhaseColor = (color) => {
            const colorMap = {
                'bg-blue-500': 'text-blue',
                'bg-green-500': 'text-green',
                'bg-purple-500': 'text-purple',
                'bg-orange-500': 'text-orange',
                'bg-red-500': 'text-red'
            };
            return colorMap[color] || 'text-blue';
        };

        window.showNotification = (message, type = 'info', duration = 3000) => {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        };

        // Funciones globales para templates
        window.scrollToFeatures = function() {
            const el = document.getElementById('features');
            if (el) el.scrollIntoView({ behavior: 'smooth' });
        };

        window.generatePlan = async function() {
            // Esperar a que aiService est√© listo
            if (!window.aiService) {
                // Si a√∫n no est√° listo, esperar
                let attempts = 0;
                return new Promise((resolve) => {
                    const waitForAI = setInterval(() => {
                        attempts++;
                        if (window.aiService || attempts > 50) {
                            clearInterval(waitForAI);
                            if (!window.aiService) {
                                console.error('‚ùå AIService no disponible');
                                window.showNotification('Error: Servicio de IA no disponible', 'error');
                                resolve();
                                return;
                            }
                            generateWithAI();
                        }
                    }, 100);
                });
            } else {
                generateWithAI();
            }
            
            async function generateWithAI() {
                // Obtener respuestas del formulario
                const responses = {
                    level: document.getElementById('level')?.value || 'beginner',
                    interests: (document.getElementById('interests')?.value || 'python').split(',').map(i => i.trim()),
                    timePerDay: document.getElementById('time')?.value || '2',
                    goal: 'career-growth',
                    deadline: '6',
                    experience: ''
                };

                try {
                    console.log('üöÄ Generando plan con AIService...');
                    
                    // Verificar que aiService est√° configurado
                    if (!window.aiService.isConfigured) {
                        console.warn('‚ö†Ô∏è Claude API no est√° configurada.');
                        window.showNotification('Configura la API key de Claude para generar tu plan. Sin IA no se crea plan.', 'error');
                        return;
                    }
                    
                    // Llamar a AIService
                    const result = await window.aiService.generateCareerPlan(responses);
                    
                    if (!result.success) {
                        console.error('‚ùå Error en respuesta de AIService:', result);
                        window.showNotification('Error generando el plan', 'error');
                        return;
                    }
                    
                    console.log('‚úÖ Plan generado exitosamente');
                    window.auth.updatePlan(result.plan);
                    window.showNotification('¬°Plan generado exitosamente!', 'success');
                    setTimeout(() => {
                        window.router.navigate('/dashboard');
                    }, 1500);
                } catch (error) {
                    console.error('‚ùå Error generando plan:', error);
                    window.showNotification('Error: ' + error.message, 'error');
                }
            }
        };

        // initDashboard eliminado: el dashboard usa loadDashboard + una card (sin fases hardcodeadas).
        // La vista limpia no tiene phasesContainer; el plan se muestra en planCardContainer.

        window.logout = function() {
            window.auth.logout();
            window.router.navigate('/');
        };

        window.initRegisterForm = function() {
            const form = document.getElementById('registerForm');
            if (!form) return;
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submitBtn');
                
                // Evitar m√∫ltiples submits
                if (submitBtn.disabled) {
                    console.log('‚è≥ El formulario ya est√° siendo procesado...');
                    return;
                }
                
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Registrando...';
                
                const formData = new FormData(form);
                const name = formData.get('name');
                const email = formData.get('email');
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');

                if (password !== confirmPassword) {
                    window.showNotification('Las contrase√±as no coinciden', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                if (!name || !email || !password) {
                    window.showNotification('Por favor completa todos los campos', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                try {
                    console.log('üîÑ Iniciando registro para:', email);
                    
                    // Verificar que Supabase est√° configurado
                    if (!window.supabase.isConfigured) {
                        console.error('‚ùå Supabase no est√° configurado');
                        window.showNotification('‚ö†Ô∏è Supabase no est√° configurado. Configura variables de entorno VITE_SUPABASE_URL y VITE_SUPABASE_ANON_KEY', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    
                    console.log('‚úÖ Supabase est√° configurado');
                    
                    // Primero registrar en Supabase Auth
                    console.log('üìù Registrando en Supabase Auth...');
                    const authResult = await window.supabase.signUp(email, password);
                    
                    if (!authResult.success) {
                        console.error('‚ùå Error en Supabase Auth:', authResult.error);
                        
                        // Mensaje especial para rate limiting
                        if (authResult.retryAfter) {
                            const minutes = Math.ceil(authResult.retryAfter / 60);
                            window.showNotification(`‚è≥ Demasiados intentos. Por favor espera ${minutes} minuto(s) antes de intentar nuevamente.`, 'error', 8000);
                            // Deshabilitar bot√≥n temporalmente
                            submitBtn.disabled = true;
                            submitBtn.textContent = `Reintenta en ${minutes}m`;
                            setTimeout(() => {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }, authResult.retryAfter * 1000);
                        } else if (authResult.error && authResult.error.includes('ya est√° registrado')) {
                            // Usuario ya existe
                            window.showNotification('Este email ya est√° registrado. Por favor inicia sesi√≥n.', 'error', 6000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            // Mostrar opci√≥n de ir a login
                            setTimeout(() => {
                                const goLogin = confirm('¬øDeseas ir a la p√°gina de inicio de sesi√≥n?');
                                if (goLogin) {
                                    window.router.navigate('/login');
                                }
                            }, 1000);
                        } else if (authResult.error && authResult.error.includes('email')) {
                            window.showNotification('‚ö†Ô∏è Problema con el email. Verifica que sea un email v√°lido.', 'error', 6000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        } else {
                            window.showNotification(authResult.error || 'Error al registrar', 'error');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                        
                        return;
                    }

                    const userId = authResult.user.id;
                    console.log('‚úÖ Usuario creado en Auth con ID:', userId);
                    
                    // Verificar si requiere confirmaci√≥n de email
                    if (authResult.needsEmailConfirmation) {
                        console.log('üìß Se envi√≥ confirmaci√≥n de email. El usuario necesita verificar su email.');
                        window.showNotification('¬°Cuenta registrada! Por favor verifica tu email para confirmar tu cuenta.', 'success', 5000);
                        setTimeout(() => {
                            window.router.navigate('/login');
                        }, 5000);
                        return;
                    }

                    // Luego crear el registro en tabla users (solo si no requiere confirmaci√≥n)
                    console.log('üì§ Insertando en tabla users...');
                    const userResult = await window.supabase.post('users', {
                        id: userId,
                        email: email,
                        name: name,
                        password_hash: 'managed_by_supabase_auth',
                        role: 'user',
                        has_plan: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                    if (!userResult.success) {
                        console.error('‚ùå Error al insertar en tabla users:', userResult.error);
                        window.showNotification('Cuenta registrada en Auth pero error al guardar perfil. Error: ' + userResult.error, 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }

                    console.log('‚úÖ Usuario insertado en tabla users');

                    // üîë AUTO-LOGIN AUTOM√ÅTICO DESPU√âS DEL REGISTRO
                    console.log('üîê Iniciando auto-login autom√°tico...');
                    const autoLoginResult = await window.supabase.signIn(email, password);
                    
                    if (!autoLoginResult.success) {
                        console.error('‚ùå Error en auto-login:', autoLoginResult.error);
                        window.showNotification('Cuenta creada pero error en auto-login. Por favor inicia sesi√≥n.', 'warning');
                        setTimeout(() => {
                            window.router.navigate('/login');
                        }, 1500);
                        return;
                    }
                    
                    // Guardar usuario en localStorage tambi√©n (para modo offline)
                    window.auth.register({ name, email, password, id: userId });
                    
                    // Marcar que viene desde REGISTER (para validar en onboarding)
                    sessionStorage.setItem('fromRegister', 'true');
                    console.log('‚úÖ Bandera de REGISTER establecida para onboarding');
                    
                    console.log('‚úÖ Auto-login completado, usuario autenticado');
                    console.log('‚úÖ Registro completado exitosamente');
                    window.showNotification('¬°Cuenta creada exitosamente!', 'success');
                    
                    // üëâ REDIRIGIR A ONBOARDING (NO al dashboard)
                    setTimeout(() => {
                        window.router.navigate('/onboarding');
                    }, 1500);
                } catch (error) {
                    console.error('‚ùå Error en registro:', error);
                    window.showNotification('Error al crear la cuenta. Intenta nuevamente. Error: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        };

        window.initLoginForm = function() {
            const form = document.getElementById('loginForm');
            if (!form) return;
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = form.querySelector('button[type="submit"]');
                
                // Evitar m√∫ltiples submits
                if (submitBtn.disabled) {
                    console.log('‚è≥ El formulario ya est√° siendo procesado...');
                    return;
                }
                
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Iniciando sesi√≥n...';
                
                const formData = new FormData(form);
                const email = formData.get('email');
                const password = formData.get('password');

                if (!email || !password) {
                    window.showNotification('Por favor completa todos los campos', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                try {
                    console.log('üîÑ Iniciando sesi√≥n para:', email);
                    
                    let loginSuccess = false;
                    
                    // Intentar con Supabase primero si est√° configurado
                    if (window.supabase && window.supabase.isConfigured) {
                        console.log('üìù Iniciando sesi√≥n en Supabase Auth...');
                        const authResult = await window.supabase.signIn(email, password);
                        
                        if (authResult.success) {
                            const user = authResult.user;
                            console.log('‚úÖ Sesi√≥n iniciada con usuario:', user.id);

                            // Obtener datos del usuario desde tabla users
                            console.log('üì• Obteniendo datos del usuario...');
                            const userResult = await window.supabase.get('users', { id: 'eq.' + user.id });
                            
                            if (userResult.success && userResult.data && userResult.data.length > 0) {
                                const userData = userResult.data[0];
                                console.log('‚úÖ Datos del usuario obtenidos');

                                // Guardar usuario en Auth y localStorage para que el dashboard reconozca la sesi√≥n
                                window.auth.setUser({
                                    id: user.id,
                                    name: userData.name,
                                    email: user.email,
                                    role: userData.role,
                                    has_plan: userData.has_plan
                                });
                                loginSuccess = true;
                            } else {
                                // Usuario en Auth pero no en tabla users: crear sesi√≥n m√≠nima para ir al dashboard
                                console.log('‚ö†Ô∏è Usuario en Auth pero sin perfil. Creando sesi√≥n m√≠nima...');
                                window.auth.setUser({
                                    id: user.id,
                                    name: user.email?.split('@')[0] || 'Usuario',
                                    email: user.email,
                                    role: 'user',
                                    has_plan: false
                                });
                                loginSuccess = true;
                            }
                        }
                    }
                    
                    // Si Supabase fall√≥ o no est√° configurado, intentar con localStorage
                    if (!loginSuccess) {
                        console.log('üìù Intentando login con localStorage (fallback)...');
                        const user = window.auth.login(email, password);
                        if (user) {
                            console.log('‚úÖ Login exitoso con localStorage');
                            loginSuccess = true;
                        }
                    }
                    
                    if (loginSuccess) {
                        console.log('‚úÖ Sesi√≥n completada exitosamente');
                        window.showNotification('¬°Bienvenido!', 'success');
                        
                        // üîë LIMPIAR BANDERAS DE ONBOARDING
                        sessionStorage.removeItem('fromRegister');
                        sessionStorage.removeItem('creatingNewPlan');
                        
                        // üëâ LOGIN SIEMPRE VA A DASHBOARD (NUNCA A ONBOARDING)
                        setTimeout(() => {
                            window.router.navigate('/dashboard');
                        }, 1500);
                    } else {
                        console.error('‚ùå Email o contrase√±a incorrectos');
                        window.showNotification('Email o contrase√±a incorrectos', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                } catch (error) {
                    console.error('‚ùå Error en inicio de sesi√≥n:', error);
                    window.showNotification('Error al iniciar sesi√≥n. Intenta nuevamente. Error: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        };

        // Contenido de las p√°ginas (inline para evitar CORS)
        const landingContent = `
<div class="landing-page">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <h3>Plan Carrera Pro</h3>
            </div>
            <div class="navbar-buttons">
                <button class="btn-outline" data-route="/login">
                    Iniciar Sesi√≥n
                </button>
                <button class="btn-primary" data-route="/register">
                    Registrarse
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">
                Crea tu <span class="gradient-text">Plan de Carrera</span> con IA
            </h1>
            <p class="hero-subtitle">
                Transforma tu futuro profesional con un plan personalizado generado por Claude AI. 
                Aprende las habilidades que el mercado realmente necesita.
            </p>
            <div class="hero-cta">
                <button class="btn-primary" data-route="/register">
                    Comenzar Gratis
                </button>
                <button class="btn-secondary" onclick="window.scrollToFeatures()">
                    Ver Caracter√≠sticas
                </button>
            </div>
        </div>
        <div class="hero-visual">
            <div class="floating-card">
                <div class="card-header">
                    <div class="dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="code-line"></div>
                    <div class="code-line"></div>
                    <div class="code-line"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features" id="features">
        <div class="container">
            <h2 class="section-title">Caracter√≠sticas Principales</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">ü§ñ</div>
                    <h3>Chat IA Integrado</h3>
                    <p>Chatea con Claude AI para resolver dudas, recibir consejos y personalizar tu aprendizaje.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <h3>Proyectos Personalizados</h3>
                    <p>Genera proyectos √∫nicos basados en tus intereses, nivel y objetivos profesionales.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>GitHub Tracking</h3>
                    <p>Integra tu progreso directamente con GitHub y construye tu portfolio profesional.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Plan Carrera Pro</h4>
                    <p>El futuro del aprendizaje tecnol√≥gico impulsado por IA.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Plan Carrera Pro. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
</div>
        `;

        const registerContent = `
<div class="register-page">
    <div class="register-container">
        <div class="register-card">
            <div class="register-header">
                <h1>Crear Cuenta</h1>
                <p>√önete a miles de profesionales aprendiendo con IA</p>
            </div>

            <form class="register-form" id="registerForm">
                <div class="form-group">
                    <label for="name">Nombre Completo</label>
                    <input type="text" id="name" name="name" required placeholder="Juan P√©rez">
                </div>

                <div class="form-group">
                    <label for="email">Correo Electr√≥nico</label>
                    <input type="email" id="email" name="email" required placeholder="juan@ejemplo.com">
                </div>

                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" name="password" required placeholder="M√≠nimo 6 caracteres">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar Contrase√±a</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Repite tu contrase√±a">
                </div>

                <button type="submit" class="btn-primary btn-full" id="submitBtn">
                    Crear Cuenta
                </button>

                <div class="form-footer">
                    <p>¬øYa tienes cuenta? <a href="#" class="link" data-route="/login">Inicia sesi√≥n</a></p>
                </div>
            </form>
        </div>

        <div class="register-info">
            <h2>¬øPor qu√© registrarte?</h2>
            <div class="benefits">
                <div class="benefit">
                    <div class="benefit-icon">üéØ</div>
                    <div>
                        <h3>Plan Personalizado</h3>
                        <p>IA crea un plan √∫nico basado en tus objetivos</p>
                    </div>
                </div>
                <div class="benefit">
                    <div class="benefit-icon">ü§ñ</div>
                    <div>
                        <h3>Chat con Claude</h3>
                        <p>Asistencia 24/7 para resolver dudas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        `;

        const loginContent = `
<div class="login-page">
    <div class="login-container">
        <div class="login-box">
            <h1>Iniciar Sesi√≥n</h1>
            <p class="login-subtitle">Bienvenido de vuelta a Plan Carrera Pro</p>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        name="email" 
                        placeholder="tu@email.com"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="loginPassword">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        name="password" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                    >
                </div>

                <button type="submit" class="btn-primary btn-full">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <div class="login-divider">
                <span>¬øNo tienes cuenta?</span>
            </div>

            <button class="btn-secondary btn-full" data-route="/register">
                Crear cuenta nueva
            </button>

            <div class="login-footer">
                <a href="#" onclick="alert('Feature coming soon'); return false;">¬øOlvidaste tu contrase√±a?</a>
                <span>‚Ä¢</span>
                <a href="#/" data-route="/">Volver al inicio</a>
            </div>
        </div>

        <div class="login-visual">
            <div class="visual-card">
                <div class="card-header">
                    <div class="dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="code-line"></div>
                    <div class="code-line"></div>
                    <div class="code-line"></div>
                </div>
            </div>
            <div class="visual-text">
                <h3>Contin√∫a tu viaje profesional</h3>
                <p>Accede a tu plan personalizado y sigue aprendiendo con IA.</p>
            </div>
        </div>
    </div>
</div>
        `;

        const onboardingContent = `
<div class="onboarding-page">
    <div class="onboarding-container">
        <div class="question-card">
            <div class="question-header">
                <h2>Onboarding Simplificado</h2>
                <p>Responde algunas preguntas para personalizar tu plan</p>
            </div>

            <div class="question-content">
                <div class="form-group">
                    <label>¬øCu√°l es tu nivel actual?</label>
                    <select id="level">
                        <option value="beginner">Principiante</option>
                        <option value="intermediate">Intermedio</option>
                        <option value="advanced">Avanzado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>¬øQu√© quieres aprender?</label>
                    <select id="interests">
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="sql">SQL</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>¬øCu√°nto tiempo tienes por d√≠a?</label>
                    <select id="time">
                        <option value="1">1 hora</option>
                        <option value="2">2 horas</option>
                        <option value="3">3+ horas</option>
                    </select>
                </div>
            </div>

            <div class="question-actions">
                <button class="btn-primary" onclick="window.generatePlan()">
                    Generar Mi Plan
                </button>
            </div>
        </div>
    </div>
</div>
        `;

        const dashboardContent = `
<div class="dashboard-page dashboard-clean">
    <header class="dashboard-header dashboard-header-clean">
        <div class="header-content">
            <div class="header-left">
                <h1 class="dashboard-title">Hola, <span id="userName">Usuario</span></h1>
                <p class="dashboard-subtitle">Tu plan de carrera</p>
            </div>
            <div class="header-right">
                <button type="button" class="btn-secondary btn-ghost" onclick="logout()">Cerrar sesi√≥n</button>
            </div>
        </div>
    </header>
    <main class="dashboard-main dashboard-main-clean">
        <section class="plan-card-section" id="planCardSection" style="display:none;"><div id="planCardContainer"></div></section>
        <section class="empty-state" id="emptyState">
            <div class="empty-content">
                <p class="empty-message">A√∫n no tienes un Plan de Carrera creado.</p>
                <p class="empty-hint">Reg√≠strate y completa el onboarding para que la IA genere tu plan seg√∫n tus opciones.</p>
            </div>
        </section>
        <div class="loading-state" id="loadingState" style="display:none;"><div class="loading-content"><div class="loading-spinner"></div><p>Cargando...</p></div></div>
        <div class="error-state" id="errorState" style="display:none;"><div class="error-content"><p id="errorMessage"></p><button type="button" class="btn-primary" onclick="loadDashboard()">Reintentar</button></div></div>
    </main>
</div>
<script>
var userPlan=null;var currentPlanId=null;
function loadDashboard(){try{if(!auth||!auth.isAuthenticated()){router.navigate('/register');return;}var user=auth.getUser();document.getElementById('userName').textContent=user.name||user.email||'Usuario';document.getElementById('loadingState').style.display='block';document.getElementById('planCardSection').style.display='none';document.getElementById('emptyState').style.display='none';document.getElementById('errorState').style.display='none';function finish(plan){userPlan=plan;if(userPlan&&!userPlan.id)userPlan.id='local-'+(userPlan.created_at?new Date(userPlan.created_at).getTime():Date.now());document.getElementById('loadingState').style.display='none';if(userPlan){renderPlanCard();document.getElementById('planCardSection').style.display='block';document.getElementById('emptyState').style.display='none';}else{document.getElementById('planCardSection').style.display='none';document.getElementById('emptyState').style.display='block';}}if(typeof planService!=='undefined'&&planService&&planService.getUserPlans){planService.getUserPlans(user.id).then(function(plans){var p=(plans&&plans.length>0)?plans[0]:null;finish(p);}).catch(function(){var s=localStorage.getItem('currentPlan');if(s)try{finish(JSON.parse(s));}catch(e){finish(null);}else finish(null);});}else{var s=localStorage.getItem('currentPlan');if(s)try{finish(JSON.parse(s));}catch(e){finish(null);}else finish(null);}}catch(e){document.getElementById('loadingState').style.display='none';document.getElementById('errorState').style.display='block';document.getElementById('errorMessage').textContent=e.message;}}
function renderPlanCard(){var c=document.getElementById('planCardContainer');if(!c||!userPlan)return;var d=userPlan.plan_content||userPlan;if(typeof d==='string')try{d=JSON.parse(d);}catch(e){d={};}var title=userPlan.title||d.title||'Plan de carrera';var desc=userPlan.description||d.description||'';var obj=userPlan.objective||d.objective||'';var dl=userPlan.estimated_duration||d.estimatedDuration||d.estimated_duration||'';var created=userPlan.created_at?function(iso){try{return new Date(iso).toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});}catch(e){return'';}}(userPlan.created_at):'';var what=desc;if(!what&&d.phases&&d.phases.length>0){var t=d.phases[0].topics||d.phases[0].learning_objectives||[];what=t.slice(0,3).join(', ');}var id=userPlan.id||'';function esc(t){if(t==null)return'';var x=document.createElement('div');x.textContent=t;return x.innerHTML;}function escA(t){if(t==null)return'';return String(t).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}c.innerHTML='<article class="plan-career-card" onclick="goToPlanDetail(\\''+escA(id)+'\\')" role="button" tabindex="0"><h2 class="plan-career-card-title">'+esc(title)+'</h2>'+(what?'<p class="plan-career-card-field"><span class="label">Qu√© vas a estudiar</span>'+esc(what)+'</p>':'')+(obj?'<p class="plan-career-card-field"><span class="label">Objetivo principal</span>'+esc(obj)+'</p>':'')+(dl?'<p class="plan-career-card-field"><span class="label">Plazo estimado</span>'+esc(dl)+'</p>':'')+(created?'<p class="plan-career-card-field plan-career-card-date"><span class="label">Fecha de creaci√≥n</span>'+esc(created)+'</p>':'')+'<p class="plan-career-card-cta">Ver detalle del plan ‚Üí</p></article>';}
function goToPlanDetail(planId){currentPlanId=planId;if(router)router.navigate('/dashboard/plan/'+planId);}
function logout(){try{if(auth)auth.logout();if(router)router.navigate('/');}catch(e){if(router)router.navigate('/');}}
if(document.readyState!=='loading')loadDashboard();else document.addEventListener('DOMContentLoaded',loadDashboard);
</scr` + `ipt>
        `;

        // Definir rutas con contenido inline
        router.addRoute('/', landingContent);
        router.addRoute('/login', loginContent);
        router.addRoute('/register', registerContent);
        router.addRoute('/onboarding', onboardingContent);
        router.addRoute('/dashboard', dashboardContent);

        // Ocultar loading y mostrar primera ruta; se ejecuta al final, cuando todo est√° definido
        function hideLoadingScreen() {
            var el = document.getElementById('loadingScreen');
            if (el) el.style.display = 'none';
        }

        // Iniciar ya: rutas est√°n registradas, DOM existe (script est√° al final del body)
        try {
            router.handleRoute();
        } catch (e) {
            console.error('Error al iniciar:', e);
            hideLoadingScreen();
            document.getElementById('app').innerHTML = '<p>No se pudo cargar. <a href="#/">Recargar</a></p>';
        }

        // Respaldo por si load/hashchange se disparan antes: volver a ocultar loading
        window.addEventListener('load', hideLoadingScreen);
        setTimeout(hideLoadingScreen, 1500);
    </script>
</body>
</html>