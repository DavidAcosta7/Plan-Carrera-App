<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../css/projects.css">
<body class="projects-page">
    <header class="projects-header">
        <div class="header-content">
            <h1>Mis Proyectos</h1>
            <p>Gestiona y sigue el progreso de todos tus proyectos</p>
        </div>
        <div class="header-actions">
            <button class="btn-primary" onclick="showAddProjectModal()">
                + Nuevo Proyecto
            </button>
        </div>
    </header>

    <main class="projects-main">
        <!-- Filters -->
        <section class="projects-filters">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterProjects('all')">Todos</button>
                <button class="filter-tab" onclick="filterProjects('active')">En Progreso</button>
                <button class="filter-tab" onclick="filterProjects('completed')">Completados</button>
                <button class="filter-tab" onclick="filterProjects('locked')">Bloqueados</button>
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Buscar proyectos..." id="projectSearch" onkeyup="searchProjects()">
            </div>
        </section>

        <!-- Projects Grid -->
        <section class="projects-grid" id="projectsGrid">
            <!-- Los proyectos se cargar√°n din√°micamente -->
        </section>

        <!-- Statistics -->
        <section class="projects-stats">
            <h2>Estad√≠sticas de Progreso</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalProjects">0</div>
                    <div class="stat-label">Total Proyectos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedProjects">0</div>
                    <div class="stat-label">Completados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inProgressProjects">0</div>
                    <div class="stat-label">En Progreso</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">Tasa de Completaci√≥n</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Add Project Modal -->
    <div class="modal" id="addProjectModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Nuevo Proyecto</h3>
                <button class="modal-close" onclick="closeModal('addProjectModal')">&times;</button>
            </div>
            <form class="modal-body" id="addProjectForm">
                <div class="form-group">
                    <label for="projectTitle">T√≠tulo del Proyecto</label>
                    <input type="text" id="projectTitle" required>
                </div>
                <div class="form-group">
                    <label for="projectDescription">Descripci√≥n</label>
                    <textarea id="projectDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="projectDifficulty">Dificultad</label>
                    <select id="projectDifficulty">
                        <option value="easy">F√°cil</option>
                        <option value="medium">Medio</option>
                        <option value="hard">Dif√≠cil</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectPhase">Fase</label>
                    <select id="projectPhase">
                        <!-- Las opciones se cargar√°n din√°micamente -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectRequirements">Requisitos (uno por l√≠nea)</label>
                    <textarea id="projectRequirements" rows="4" placeholder="Requisito 1&#10;Requisito 2&#10;Requisito 3"></textarea>
                </div>
                <div class="form-group">
                    <label for="projectGithub">Consejos para GitHub</label>
                    <input type="text" id="projectGithub" placeholder="Consejos para el repositorio">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('addProjectModal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Agregar Proyecto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Details Modal -->
    <div class="modal" id="projectDetailsModal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="detailsProjectTitle">Detalles del Proyecto</h3>
                <button class="modal-close" onclick="closeModal('projectDetailsModal')">&times;</button>
            </div>
            <div class="modal-body" id="projectDetailsContent">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
        </div>
    </div>
</div>

<script>
let currentFilter = 'all';
let userProjects = [];
let currentPlanId = null;
let currentPlanContent = null;
let currentProgress = { completedProjects: [], completedPhases: [], expandedPhases: [1] };

async function initProjectsPage() {
    if (!router.requireAuth()) return;
    await loadUserProjects();
    renderProjects();
    updateStatistics();
    setupEventListeners();
}

async function loadUserProjects() {
    try {
        const supaUser = window.supabase && window.supabase.getCurrentUser ? window.supabase.getCurrentUser() : null;
        if (!supaUser) return;
        const plans = await planService.getUserPlans(supaUser.id);
        const plan = plans && plans[0];
        if (!plan) return;
        const content = plan.plan_content || {};
        currentPlanId = plan.id;
        currentPlanContent = content;
        try {
            currentProgress = await planService.getProgress(supaUser.id, currentPlanId);
        } catch (_) {
            currentProgress = { completedProjects: [], completedPhases: [], expandedPhases: [1] };
        }
        userProjects = [];
        (content.phases || []).forEach(function(phase, pIdx) {
            (phase.projects || []).forEach(function(project, idx) {
                const projId = project.id || [plan.id, pIdx, idx].join('-');
                userProjects.push({
                    id: projId,
                    title: project.title || project.name || 'Proyecto',
                    description: project.description || '',
                    difficulty: (project.difficulty || 'medium').toLowerCase(),
                    requirements: project.requirements || [],
                    githubTips: project.github_tips || '',
                    phaseId: phase.id != null ? phase.id : pIdx,
                    phaseTitle: phase.title || 'Fase ' + (pIdx + 1),
                    phaseColor: phase.color || '#716FE9',
                    isCompleted: Array.isArray(currentProgress.completedProjects) ? currentProgress.completedProjects.includes(projId) : false,
                    isLocked: false
                });
            });
        });
    } catch (e) {
        console.error('Error cargando proyectos:', e);
    }
}

function renderProjects() {
    const grid = document.getElementById('projectsGrid');
    const filteredProjects = filterProjectsByStatus(currentFilter);
    const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
    
    const projectsToShow = filteredProjects.filter(project => 
        project.title.toLowerCase().includes(searchTerm) ||
        project.description.toLowerCase().includes(searchTerm)
    );
    
    if (projectsToShow.length === 0) {
        grid.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìÅ</div>
                <h3>No se encontraron proyectos</h3>
                <p>Intenta ajustar los filtros o el t√©rmino de b√∫squeda</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = projectsToShow.map(project => renderProjectCard(project)).join('');
}

function renderProjectCard(project) {
    const statusClass = project.isCompleted ? 'completed' : 
                       project.isLocked ? 'locked' : 'active';
    
    return `
        <div class="project-card ${statusClass}" onclick="showProjectDetails('${project.id}')">
            <div class="project-header">
                <span class="difficulty-badge ${getDifficultyColor(project.difficulty)}">
                    ${getDifficultyLabel(project.difficulty)}
                </span>
                <div class="project-status">
                    ${project.isCompleted ? '‚úÖ' : project.isLocked ? 'üîí' : 'üîÑ'}
                </div>
            </div>
            
            <h3 class="project-title">${project.title}</h3>
            <p class="project-description">${project.description}</p>
            
            <div class="project-meta">
                <span class="project-phase" style="background: ${project.phaseColor}">
                    ${project.phaseTitle}
                </span>
            </div>
            
            <div class="project-actions">
                ${!project.isLocked ? `
                    <button class="btn-small" onclick="event.stopPropagation(); toggleProjectStatus('${project.id}')">
                        ${project.isCompleted ? 'Marcar como Incompleto' : 'Marcar como Completo'}
                    </button>
                ` : ''}
                <button class="btn-small btn-secondary" onclick="event.stopPropagation(); showProjectDetails('${project.id}')">
                    Ver Detalles
                </button>
            </div>
        </div>
    `;
}

function filterProjectsByStatus(status) {
    switch (status) {
        case 'active':
            return userProjects.filter(p => !p.isCompleted && !p.isLocked);
        case 'completed':
            return userProjects.filter(p => p.isCompleted);
        case 'locked':
            return userProjects.filter(p => p.isLocked);
        default:
            return userProjects;
    }
}

function filterProjects(status) {
    currentFilter = status;
    
    // Actualizar tabs activos
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderProjects();
}

function searchProjects() {
    renderProjects();
}

function updateStatistics() {
    const total = userProjects.length;
    const completed = userProjects.filter(p => p.isCompleted).length;
    const inProgress = userProjects.filter(p => !p.isCompleted && !p.isLocked).length;
    const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    document.getElementById('totalProjects').textContent = total;
    document.getElementById('completedProjects').textContent = completed;
    document.getElementById('inProgressProjects').textContent = inProgress;
    document.getElementById('completionRate').textContent = `${completionRate}%`;
}

function showAddProjectModal() {
    const modal = document.getElementById('addProjectModal');
    const phaseSelect = document.getElementById('projectPhase');
    
    const phases = (currentPlanContent && currentPlanContent.phases) || [];
    phaseSelect.innerHTML = phases.map(function(phase, idx) {
        var id = phase.id != null ? phase.id : idx;
        var title = phase.title || ('Fase ' + (idx + 1));
        return '<option value="' + id + '">' + title + '</option>';
    }).join('');
    
    modal.style.display = 'flex';
}

function showProjectDetails(projectId) {
    const project = userProjects.find(p => p.id === projectId);
    if (!project) return;
    
    const modal = document.getElementById('projectDetailsModal');
    const content = document.getElementById('projectDetailsContent');
    
    document.getElementById('detailsProjectTitle').textContent = project.title;
    
    content.innerHTML = `
        <div class="project-details">
            <div class="detail-section">
                <h4>Descripci√≥n</h4>
                <p>${project.description}</p>
            </div>
            
            <div class="detail-section">
                <h4>Informaci√≥n General</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Dificultad:</span>
                        <span class="difficulty-badge ${getDifficultyColor(project.difficulty)}">
                            ${getDifficultyLabel(project.difficulty)}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Fase:</span>
                        <span class="project-phase" style="background: ${project.phaseColor}">
                            ${project.phaseTitle}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Estado:</span>
                        <span class="project-status">
                            ${project.isCompleted ? '‚úÖ Completado' : project.isLocked ? 'üîí Bloqueado' : 'üîÑ En Progreso'}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h4>Requisitos</h4>
                <ul class="requirements-list">
                    ${project.requirements.map(req => `<li>${req}</li>`).join('')}
                </ul>
            </div>
            
            <div class="detail-section">
                <h4>Consejos para GitHub</h4>
                <div class="github-tips">
                    <p>${project.githubTips}</p>
                </div>
            </div>
            
            ${!project.isLocked ? `
                <div class="detail-actions">
                    <button class="btn-primary" onclick="toggleProjectStatus('${project.id}'); closeModal('projectDetailsModal');">
                        ${project.isCompleted ? 'Marcar como Incompleto' : 'Marcar como Completo'}
                    </button>
                </div>
            ` : ''}
        </div>
    `;
    
    modal.style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

async function toggleProjectStatus(projectId) {
    try {
        const supaUser = window.supabase && window.supabase.getCurrentUser ? window.supabase.getCurrentUser() : null;
        if (!supaUser || !currentPlanId) return;
        const idx = (currentProgress.completedProjects || []).indexOf(projectId);
        if (idx > -1) {
            currentProgress.completedProjects.splice(idx, 1);
        } else {
            currentProgress.completedProjects.push(projectId);
        }
        await planService.saveProgress(supaUser.id, currentPlanId, currentProgress);
        userProjects = userProjects.map(function(p) {
            if (p.id === projectId) return { ...p, isCompleted: idx === -1 };
            return p;
        });
        renderProjects();
        updateStatistics();
        showNotification(idx > -1 ? 'Proyecto marcado como incompleto' : '¬°Proyecto completado!', 'success');
    } catch (e) {
        console.error('Error al actualizar progreso:', e);
        showNotification('No se pudo actualizar el estado del proyecto', 'error');
    }
}

function isProjectUnlocked(phaseId, project) {
    const user = auth.getUser();
    const phase = user.plan.phases.find(p => p.id === phaseId);
    if (!phase) return false;

    const phaseCompleted = user.progress.completedPhases.includes(phaseId);
    const projectsCompletedInPhase = phase.projects.filter(p => user.progress.completedProjects.includes(p.id)).length;
    const itemsCompletedCount = (phaseCompleted ? phase.items.length : 0) + projectsCompletedInPhase;

    return itemsCompletedCount >= (project.unlockAt || 0);
}

function setupEventListeners() {
    // Formulario de agregar proyecto
    document.getElementById('addProjectForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Por ahora solo mostramos una notificaci√≥n
        // En una implementaci√≥n real, agregar√≠amos el proyecto al plan del usuario
        showNotification('Funci√≥n de agregar proyectos pr√≥ximamente', 'info');
        closeModal('addProjectModal');
    });
    
    // Cerrar modales al hacer clic fuera
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
}

// Inicializar p√°gina
document.addEventListener('DOMContentLoaded', initProjectsPage);
</script>
