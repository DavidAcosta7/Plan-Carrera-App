<!--
  Vista detallada de un Plan de Carrera
  Ruta: /dashboard/plans/[planId]
  Muestra título, objetivo, plazo, fases y proyectos del plan.
-->
<link rel="stylesheet" href="../css/styles.css">
<link rel="stylesheet" href="../css/plan-detail.css">
<body class="plan-detail-page">
    <header class="plan-detail-header">
        <div class="header-content">
            <a href="#/dashboard" class="back-link" data-route="/dashboard">← Volver al Dashboard</a>
            <h1 class="plan-detail-title" id="planDetailTitle">Plan de Carrera</h1>
            <p class="plan-detail-meta" id="planDetailMeta"></p>
        </div>
    </header>

    <main class="plan-detail-main">
        <!-- Resumen del plan (se muestra al cargar) -->
        <section class="plan-summary" id="planSummary" style="display: none;">
            <div class="summary-card">
                <h2>Objetivo</h2>
                <p id="planObjective">—</p>
            </div>
            <div class="summary-card">
                <h2>Plazo</h2>
                <p id="planDeadline">—</p>
            </div>
            <div class="summary-card">
                <h2>Fecha de creación</h2>
                <p id="planCreatedAt">—</p>
            </div>
        </section>

        <!-- Fases del plan (se muestra al cargar) -->
        <section class="plan-phases" id="planPhasesSection" style="display: none;">
            <h2 class="section-title">Fases del plan</h2>
            <div id="phasesContainer">
                <!-- Las fases se cargan dinámicamente -->
            </div>
        </section>

        <!-- Loading -->
        <div class="loading-state" id="loadingState">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Cargando plan...</p>
            </div>
        </div>

        <!-- Error -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-content">
                <p id="errorMessage"></p>
                <button class="btn-primary" data-route="/dashboard">Volver al Dashboard</button>
            </div>
        </div>
    </main>
</div>

<script>
/**
 * Vista detallada de Plan de Carrera
 * Obtiene planId del hash (#/dashboard/plans/[planId]) y carga el plan desde BD.
 */
(function() {
    function getPlanIdFromHash() {
        const hash = (window.location.hash || '').replace(/^#/, '');
        const match = hash.match(/^\/dashboard\/plan[s]?\/([^/]+)/);
        return match ? match[1] : null;
    }

    async function loadPlanDetail() {
        const planId = getPlanIdFromHash();
        const loadingEl = document.getElementById('loadingState');
        const errorEl = document.getElementById('errorState');
        const summaryEl = document.getElementById('planSummary');
        const phasesSection = document.getElementById('planPhasesSection');

        if (!planId) {
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl) {
                document.getElementById('errorMessage').textContent = 'ID de plan no válido.';
                errorEl.style.display = 'block';
            }
            return;
        }

        if (!auth || !auth.isAuthenticated()) {
            if (window.router) window.router.navigate('/register');
            return;
        }

        try {
            if (loadingEl) loadingEl.style.display = 'block';
            if (errorEl) errorEl.style.display = 'none';

            let plan = null;
            if (typeof planService !== 'undefined' && planService && planService.getPlanById && !planId.startsWith('local-')) {
                plan = await planService.getPlanById(planId);
            }
            if (!plan) {
                const saved = localStorage.getItem('currentPlan');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.id === planId || planId.startsWith('local-')) plan = { ...parsed, plan_content: typeof parsed.plan_content === 'object' ? parsed.plan_content : parsed };
                }
            }

            if (loadingEl) loadingEl.style.display = 'none';

            if (!plan) {
                document.getElementById('errorMessage').textContent = 'No se encontró el plan.';
                errorEl.style.display = 'block';
                return;
            }

            const content = plan.plan_content || plan;
            const title = plan.title || content.plan_title || content.title || 'Plan sin título';
            const objective = plan.objective || content.objective || content.description || 'Objetivo no especificado';
            const totalWeeks = content.total_weeks || plan.timeline_weeks;
            const deadline = plan.estimated_duration || content.estimatedDuration || content.deadline ||
                (totalWeeks ? totalWeeks + ' semanas' : 'Plazo no especificado');
            const createdAt = plan.created_at
                ? new Date(plan.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })
                : 'Fecha no disponible';

            document.getElementById('planDetailTitle').textContent = title;
            document.getElementById('planDetailMeta').textContent = totalWeeks ? totalWeeks + ' semanas • Plan de carrera' : 'Plan de carrera';
            document.getElementById('planObjective').textContent = objective;
            document.getElementById('planDeadline').textContent = deadline;
            document.getElementById('planCreatedAt').textContent = createdAt;

            const phases = content.phases || [];
            const container = document.getElementById('phasesContainer');
            function esc(s) { if (s == null) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

            if (phases.length === 0) {
                container.innerHTML = '<p class="empty-phases">No hay fases definidas en este plan.</p>';
            } else {
                container.innerHTML = phases.map(function(phase, idx) {
                    const phaseId = 'phase-' + (phase.id != null ? phase.id : idx);
                    const durationWeeks = phase.duration_weeks || phase.duration;
                    const durationStr = durationWeeks ? durationWeeks + (durationWeeks === 1 ? ' semana' : ' semanas') : '';
                    const projects = phase.projects || [];
                    const projectCount = projects.length;
                    const learningItems = phase.learning_items || phase.items || [];
                    const resources = phase.resources || [];

                    const learningHtml = learningItems.length
                        ? '<div class="plan-detail-block"><h4 class="plan-detail-block-title">Qué aprenderás</h4><ul class="plan-detail-learning-list">' +
                          learningItems.map(function(item) { return '<li>' + esc(item) + '</li>'; }).join('') + '</ul></div>'
                        : '';

                    const resourcesHtml = resources.length
                        ? '<div class="plan-detail-block"><h4 class="plan-detail-block-title">Cursos</h4><div class="plan-detail-courses">' +
                          resources.map(function(r) {
                              const url = r.url || '#';
                              return '<a class="plan-detail-course-link" href="' + esc(url) + '" target="_blank" rel="noopener">' + esc(r.title || 'Recurso') + '</a>';
                          }).join('') + '</div></div>'
                        : '';

                    const projectCards = projects.map(function(p) {
                        const diff = (p.difficulty || 'medium').toLowerCase();
                        const diffLabel = diff === 'easy' ? 'Fácil' : diff === 'hard' ? 'Difícil' : 'Medio';
                        const reqs = p.requirements || [];
                        const reqList = reqs.length ? '<ul class="plan-detail-reqs">' + reqs.map(function(r) { return '<li>' + esc(r) + '</li>'; }).join('') + '</ul>' : '';
                        const githubTips = p.github_tips ? '<div class="plan-detail-github-tips"><strong>GitHub:</strong> ' + esc(p.github_tips) + '</div>' : '';
                        return '<div class="plan-detail-project-card" data-difficulty="' + diff + '">' +
                            '<span class="plan-detail-difficulty plan-detail-difficulty-' + diff + '">' + esc(diffLabel) + '</span>' +
                            '<h5 class="plan-detail-project-title">' + esc(p.title || p.name || 'Proyecto') + '</h5>' +
                            (p.description ? '<p class="plan-detail-project-desc">' + esc(p.description) + '</p>' : '') +
                            (reqList ? '<div class="plan-detail-reqs-wrap">Requisitos:' + reqList + '</div>' : '') +
                            githubTips +
                            '<button type="button" class="btn-secondary plan-detail-mark-done">Marcar como hecho</button>' +
                            '</div>';
                    }).join('');

                    const bodyHtml = '<div class="plan-detail-phase-body">' +
                        learningHtml + resourcesHtml +
                        '<div class="plan-detail-block"><h4 class="plan-detail-block-title">Proyectos para GitHub</h4><div class="plan-detail-projects-grid">' + projectCards + '</div></div>' +
                        '</div>';

                    return '<div class="plan-detail-phase-card" data-phase-id="' + phaseId + '">' +
                        '<div class="plan-detail-phase-header" role="button" tabindex="0" aria-expanded="true" data-toggle="phase">' +
                        '<span class="plan-detail-phase-title">' + esc(phase.title || 'Fase ' + (idx + 1)) + '</span>' +
                        '<span class="plan-detail-phase-meta">' + esc(durationStr) + (projectCount ? ' • 0/' + projectCount + ' proyectos' : '') + '</span>' +
                        '<span class="plan-detail-phase-chevron" aria-hidden="true">▼</span>' +
                        '</div>' + bodyHtml + '</div>';
                }).join('');
            }

            // Toggle expand/collapse
            container.querySelectorAll('.plan-detail-phase-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    var card = header.closest('.plan-detail-phase-card');
                    var body = card && card.querySelector('.plan-detail-phase-body');
                    var open = body && body.style.display !== 'none';
                    if (body) body.style.display = open ? 'none' : 'block';
                    header.setAttribute('aria-expanded', open ? 'false' : 'true');
                    var chevron = header.querySelector('.plan-detail-phase-chevron');
                    if (chevron) chevron.textContent = open ? '▶' : '▼';
                });
            });

            if (summaryEl) summaryEl.style.display = 'grid';
            if (phasesSection) phasesSection.style.display = 'block';
        } catch (err) {
            console.error('Error cargando plan:', err);
            if (loadingEl) loadingEl.style.display = 'none';
            document.getElementById('errorMessage').textContent = err.message || 'Error al cargar el plan.';
            errorEl.style.display = 'block';
        }
    }

    window.loadPlanDetail = loadPlanDetail;

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadPlanDetail);
    } else {
        loadPlanDetail();
    }
})();
</script>
