<!--
  Dashboard Plan Carrera - Versión limpia
  Header + área de contenido lista para mostrar la card del plan (próximo paso)
-->
<div class="dashboard-page dashboard-clean">
    <header class="dashboard-header dashboard-header-clean">
        <div class="header-content">
            <div class="header-left">
                <h1 class="dashboard-title">Hola, <span id="userName">Usuario</span></h1>
                <p class="dashboard-subtitle">Gestiona tu plan de carrera</p>
            </div>
            <div class="header-right">
                <button type="button" class="btn-cta" onclick="startNewPlanOnboarding()">
                    <span class="btn-cta-icon">+</span>
                    Nuevo Plan Carrera
                </button>
                <button type="button" class="btn-secondary btn-ghost" onclick="logout()">Cerrar sesión</button>
            </div>
        </div>
    </header>

    <main class="dashboard-main dashboard-main-clean">
        <!-- Contenedor donde se mostrará la card del plan (cuando exista) -->
        <section class="plans-section" id="plansSection" style="display: none;">
            <h2 class="section-title">Mis Plan Carrera</h2>
            <div class="plans-grid" id="plansGrid"></div>
        </section>

        <!-- Estado vacío: sin plan aún -->
        <section class="empty-state" id="emptyState">
            <div class="empty-content">
                <p class="empty-message">Aún no tienes un plan de carrera.</p>
                <p class="empty-hint">Completa el onboarding para crear tu plan según tus opciones.</p>
                <button type="button" class="btn-cta btn-cta-empty" onclick="startNewPlanOnboarding()">
                    <span class="btn-cta-icon">+</span>
                    Crear mi plan
                </button>
            </div>
        </section>

        <!-- Loading -->
        <div class="loading-state" id="loadingState" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>Cargando...</p>
            </div>
        </div>

        <!-- Error -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-content">
                <p id="errorMessage"></p>
                <button type="button" class="btn-primary" onclick="loadDashboard()">Reintentar</button>
            </div>
        </div>
    </main>
</div>

<script>
/**
 * Dashboard limpio - Lógica lista para mostrar la card del plan (siguiente paso)
 */
var userPlans = [];
var currentPlan = null;
var currentPlanId = null;

function loadDashboard() {
    try {
        if (!auth || !auth.isAuthenticated()) {
            router.navigate('/register');
            return;
        }

        var user = auth.getUser();
        document.getElementById('userName').textContent = user.name || user.email || 'Usuario';

        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('plansSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('errorState').style.display = 'none';

        if (typeof planService !== 'undefined' && planService && planService.getUserPlans) {
            planService.getUserPlans(user.id).then(function(plans) {
                userPlans = plans || [];
                finishLoadDashboard();
            }).catch(function(err) {
                console.warn('PlanService no disponible o error:', err);
                userPlans = [];
                var saved = localStorage.getItem('currentPlan');
                if (saved) try { userPlans = [JSON.parse(saved)]; } catch (e) {}
                finishLoadDashboard();
            });
        } else {
            var saved = localStorage.getItem('currentPlan');
            if (saved) try { userPlans = [JSON.parse(saved)]; } catch (e) {}
            finishLoadDashboard();
        }
    } catch (error) {
        console.error('Error cargando dashboard:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
    }
}

function finishLoadDashboard() {
    document.getElementById('loadingState').style.display = 'none';
    if (userPlans && userPlans.length > 0) {
        renderPlans();
        document.getElementById('plansSection').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
    } else {
        document.getElementById('plansSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
    }
}

/**
 * Renderiza las cards de planes (en el siguiente paso se hará la card representativa del onboarding)
 */
function renderPlans() {
    var grid = document.getElementById('plansGrid');
    if (!grid) return;
    grid.innerHTML = userPlans.map(function(plan) {
        var content = plan.plan_content || plan;
        var title = plan.title || content.title || 'Plan de carrera';
        var id = plan.id || '';
        return '<article class="plan-card-clean" onclick="selectPlan(\'' + id + '\', this)" data-plan-id="' + id + '">' +
            '<h3 class="plan-card-title">' + escapeHtml(title) + '</h3>' +
            '<p class="plan-card-meta">Ver detalle</p>' +
            '</article>';
    }).join('');
}

function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function selectPlan(planId, el) {
    currentPlanId = planId;
    currentPlan = userPlans.filter(function(p) { return p.id === planId; })[0];
    if (router) router.navigate('/dashboard/plans/' + planId);
}

function startNewPlanOnboarding() {
    sessionStorage.setItem('creatingNewPlan', 'true');
    localStorage.removeItem('currentQuestion');
    localStorage.removeItem('userAnswers');
    if (router) router.navigate('/onboarding');
}

function logout() {
    try {
        if (auth) auth.logout();
        if (router) router.navigate('/');
    } catch (e) {
        if (router) router.navigate('/');
    }
}

function showNotification(msg, type) {
    type = type || 'info';
    var el = document.createElement('div');
    el.className = 'notification notification-' + type;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(function() { el.classList.add('show'); }, 100);
    setTimeout(function() {
        el.classList.remove('show');
        setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 300);
    }, 3000);
}

if (document.readyState !== 'loading') {
    loadDashboard();
} else {
    document.addEventListener('DOMContentLoaded', loadDashboard);
}
</script>
