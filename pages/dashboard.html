<!--
  Dashboard - Plan Carrera (Fase 1)
  - Un solo Plan Carrera por usuario
  - El plan se genera únicamente en el onboarding por la IA
  - El dashboard solo muestra:
      - Estado vacío (si no hay plan)
      - Card del plan (si existe)
  - NO múltiples planes
  - NO botón "Nuevo Plan Carrera"
-->

<div class="dashboard-page dashboard-clean">

    <!-- HEADER -->
    <header class="dashboard-header">
      <div class="header-content">
        <h1 class="dashboard-title">
          Hola, <span id="userName">Usuario</span>
        </h1>
        <button class="btn-ghost" onclick="logout()">Cerrar sesión</button>
      </div>
    </header>
  
    <!-- MAIN -->
    <main class="dashboard-main">
  
      <!-- LOADING -->
      <section id="loadingState" class="state loading" hidden>
        <div class="spinner"></div>
        <p>Cargando tu dashboard…</p>
      </section>
  
      <!-- EMPTY STATE -->
      <section id="emptyState" class="state empty" hidden>
        <p class="empty-title">Aún no tienes un Plan de Carrera</p>
        <p class="empty-text">
          Completa el onboarding para que la IA cree tu plan personalizado.
        </p>
      </section>
  
      <!-- PLAN CARD -->
      <section id="planSection" class="plan-section" hidden>
        <div id="planCard"></div>
      </section>
  
      <!-- ERROR -->
      <section id="errorState" class="state error" hidden>
        <p id="errorMessage"></p>
        <button class="btn-primary" onclick="loadDashboard()">Reintentar</button>
      </section>
  
    </main>
  </div>
  
  <script>
  /*
    Dashboard logic
    - 1 usuario = 1 plan
    - El plan proviene del onboarding (IA)
  */
  
  let currentPlan = null;
  
  function loadDashboard() {
    try {
      if (!auth || !auth.isAuthenticated()) {
        router.navigate('/login');
        return;
      }
  
      const user = auth.getUser();
      document.getElementById('userName').textContent =
        user.name || user.email || 'Usuario';
  
      showState('loading');
  
      // Un solo plan por usuario: getUserPlans devuelve array; tomamos el primero
      function finish(plan) {
        currentPlan = plan || null;
        if (currentPlan) {
          if (!currentPlan.id) currentPlan.id = 'local-' + (currentPlan.created_at ? new Date(currentPlan.created_at).getTime() : Date.now());
          renderPlanCard(currentPlan);
          showState('plan');
        } else {
          showState('empty');
        }
      }
  
      if (typeof planService !== 'undefined' && planService && planService.getUserPlans) {
        planService.getUserPlans(user.id)
          .then(plans => finish(plans && plans.length ? plans[0] : null))
          .catch(() => {
            try {
              const saved = localStorage.getItem('currentPlan');
              finish(saved ? JSON.parse(saved) : null);
            } catch (e) { finish(null); }
          });
      } else {
        try {
          const saved = localStorage.getItem('currentPlan');
          finish(saved ? JSON.parse(saved) : null);
        } catch (e) { finish(null); }
      }
  
    } catch (err) {
      console.error(err);
      showError('Error inesperado al cargar el dashboard');
    }
  }
  
  function renderPlanCard(plan) {
    const container = document.getElementById('planCard');
    if (!container) return;

    const content = typeof plan.plan_content === 'string'
      ? (() => { try { return JSON.parse(plan.plan_content); } catch (e) { return {}; } })()
      : (plan.plan_content || plan);
    const title = plan.title || content.title || 'Plan de carrera';
    const description = plan.description || content.description || '';
    const objective = plan.objective || content.objective || '';
    const deadline = plan.estimated_duration || content.estimatedDuration || content.estimated_duration || '';
    const created = plan.created_at ? formatDate(plan.created_at) : '';

    container.innerHTML = `
      <article class="plan-card" onclick="openPlan('${escapeAttr(plan.id)}')" role="button" tabindex="0">
        <h2>${escapeHtml(title)}</h2>
        ${description ? `<p><strong>Qué vas a estudiar:</strong><br>${escapeHtml(description)}</p>` : ''}
        ${objective ? `<p><strong>Objetivo:</strong><br>${escapeHtml(objective)}</p>` : ''}
        ${deadline ? `<p><strong>Plazo estimado:</strong><br>${escapeHtml(deadline)}</p>` : ''}
        ${created ? `<p class="plan-date">Creado el ${escapeHtml(created)}</p>` : ''}
        <span class="plan-cta">Ver plan completo →</span>
      </article>
    `;
  }

  function escapeAttr(text) {
    if (text == null) return '';
    return String(text).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }
  
  function openPlan(planId) {
    router.navigate(`/dashboard/plan/${planId}`);
  }
  
  /* =====================
     Helpers
  ===================== */
  
  function showState(state) {
    document.getElementById('loadingState')?.setAttribute('hidden', true);
    document.getElementById('emptyState')?.setAttribute('hidden', true);
    document.getElementById('planSection')?.setAttribute('hidden', true);
    document.getElementById('errorState')?.setAttribute('hidden', true);
  
    if (state === 'plan') {
      document.getElementById('planSection')?.removeAttribute('hidden');
    } else {
      const el = state === 'loading' ? 'loadingState' : state === 'empty' ? 'emptyState' : 'errorState';
      document.getElementById(el)?.removeAttribute('hidden');
    }
  }
  
  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    showState('error');
  }
  
  function formatDate(date) {
    return new Date(date).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
  
  function logout() {
    auth.logout();
    router.navigate('/');
  }
  
  document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
  