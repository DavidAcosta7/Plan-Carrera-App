<div class="dashboard-page">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="dashboard-title" id="dashboardTitle">Dashboard</h1>
                <p class="dashboard-subtitle" id="dashboardSubtitle">Gestiona tus planes de carrera</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="userName">Usuario</span>
                    <button class="btn-secondary" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Secci√≥n: Mis Plan Carrera -->
        <section class="plans-section" id="plansSection" style="display: none;">
            <h2 class="section-title">Mis Plan Carrera</h2>
            <div class="plans-grid" id="plansGrid">
                <!-- Los planes se cargar√°n din√°micamente -->
            </div>
        </section>

        <!-- Empty State -->
        <section class="empty-state" id="emptyState">
            <div class="empty-content">
                <h2 class="section-title">Mis Plan Carrera</h2>
                <div class="empty-icon">üìö</div>
                <h3>No tienes planes a√∫n</h3>
                <p>¬°Comienza tu viaje de aprendizaje!</p>
            </div>
        </section>

        <!-- Loading State -->
        <div class="loading-state" id="loadingState" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h3>Cargando tus planes...</h3>
            </div>
        </div>

        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-content">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h2>Error cargando planes</h2>
                <p id="errorMessage"></p>
                <button class="btn-primary" onclick="loadDashboard()">Reintentar</button>
            </div>
        </div>

        <!-- Bot√≥n Nuevo Plan Carrera (parte inferior, centrado) -->
        <div class="new-plan-button-container">
            <button class="btn-primary btn-large" onclick="startNewPlanOnboarding()">
                Nuevo Plan Carrera
            </button>
        </div>
    </main>


    <!-- Chat Component -->
    <div id="chatComponent"></div>
</div>

<script>
/**
 * Script del Dashboard mejorado
 * Maneja m√∫ltiples planes generados por IA desde Supabase
 */

let userPlans = [];
let currentPlan = null;
let currentPlanId = null;

/**
 * Inicializa el dashboard
 */
async function loadDashboard() {
    try {
        // Verificar autenticaci√≥n
        if (!auth.isAuthenticated()) {
            router.navigate('/register');
            return;
        }

        const user = auth.getUser();
        
        console.log('üìä Cargando dashboard para:', user.name);

        // Actualizar informaci√≥n del usuario
        document.getElementById('userName').textContent = user.name;

        // Mostrar loading
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('plansSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';

        // Cargar planes del usuario
        if (planService) {
            userPlans = await planService.getUserPlans(user.id);
            console.log('‚úÖ Planes cargados:', userPlans.length);
        } else {
            console.warn('‚ö†Ô∏è PlanService no disponible, usando localStorage');
            const savedPlan = localStorage.getItem('currentPlan');
            if (savedPlan) {
                userPlans = [JSON.parse(savedPlan)];
            }
        }

        // Ocultar loading
        document.getElementById('loadingState').style.display = 'none';

        // Renderizar planes o mostrar empty state
        if (userPlans && userPlans.length > 0) {
            renderPlans();
            document.getElementById('plansSection').style.display = 'block';
        } else {
            document.getElementById('emptyState').style.display = 'block';
        }

        // Cargar componente de chat
        loadChatComponent();
    } catch (error) {
        console.error('‚ùå Error cargando dashboard:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
    }
}

/**
 * Renderiza la lista de planes del usuario
 * Muestra: T√≠tulo, Objetivo, Plazo y Fecha de creaci√≥n
 */
function renderPlans() {
    const plansGrid = document.getElementById('plansGrid');

    plansGrid.innerHTML = userPlans
        .map((plan) => {
            const planContent = plan.plan_content || plan;
            const title = plan.title || planContent.title || 'Plan sin t√≠tulo';
            const objective = plan.objective || planContent.objective || planContent.description || 'Objetivo no especificado';
            const deadline = plan.estimated_duration || planContent.estimatedDuration || planContent.deadline || 'Plazo no especificado';
            const createdAt = plan.created_at ? new Date(plan.created_at).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Fecha no disponible';
            
            return `
        <div class="plan-card" onclick="selectPlan('${plan.id}', this)">
            <div class="plan-card-header">
                <h3 class="plan-card-title">${title}</h3>
            </div>
            
            <div class="plan-card-body">
                <div class="plan-card-field">
                    <span class="plan-field-label">Objetivo:</span>
                    <span class="plan-field-value">${objective}</span>
                </div>
                <div class="plan-card-field">
                    <span class="plan-field-label">Plazo:</span>
                    <span class="plan-field-value">${deadline}</span>
                </div>
                <div class="plan-card-field">
                    <span class="plan-field-label">Fecha de creaci√≥n:</span>
                    <span class="plan-field-value">${createdAt}</span>
                </div>
            </div>
            
            <div class="plan-card-footer">
                <div class="plan-actions">
                    <button class="btn-small" onclick="event.stopPropagation(); editPlan('${plan.id}')">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn-small" onclick="event.stopPropagation(); deletePlanConfirm('${plan.id}')">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>
        `;
        })
        .join('');
}

/**
 * Selecciona un plan y lo muestra
 */
async function selectPlan(planId, element) {
    currentPlanId = planId;
    currentPlan = userPlans.find((p) => p.id === planId);

    // Actualizar UI
    document.querySelectorAll('.plan-card').forEach((card) => {
        card.classList.remove('active');
    });
    if (element) {
        element.classList.add('active');
    }

    // Navigar a la vista de plan (ruta seg√∫n especificaciones: /dashboard/plans/[planId])
    // Nota: Actualmente redirige a /plan/[planId] hasta que se implemente la p√°gina de detalle
    router.navigate(`/dashboard/plans/${planId}`);
}

/**
 * Inicia el onboarding para crear un nuevo plan
 * Llamado desde el bot√≥n "Nuevo Plan Carrera"
 */
function startNewPlanOnboarding() {
    // üîë ESTABLECER BANDERA para validar en onboarding
    sessionStorage.setItem('creatingNewPlan', 'true');
    console.log('‚úÖ Bandera creatingNewPlan establecida');
    
    // Resetear estado del onboarding
    localStorage.removeItem('currentQuestion');
    localStorage.removeItem('userAnswers');
    
    // Redirigir al onboarding
    router.navigate('/onboarding');
}

/**
 * Edita un plan existente
 */
function editPlan(planId) {
    console.log('‚úèÔ∏è Editando plan:', planId);
    // TODO: Implementar edici√≥n de plan
    showNotification('Funcionalidad de edici√≥n pr√≥ximamente', 'info');
}

/**
 * Confirma eliminaci√≥n de plan
 */
function deletePlanConfirm(planId) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar este plan?')) {
        deletePlan(planId);
    }
}

/**
 * Elimina un plan
 */
async function deletePlan(planId) {
    try {
        if (planService) {
            await planService.deletePlan(planId);
        }

        // Actualizar lista
        userPlans = userPlans.filter((p) => p.id !== planId);
        renderPlans();

        showNotification('Plan eliminado', 'success');

        if (userPlans.length === 0) {
            document.getElementById('plansSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
    } catch (error) {
        console.error('Error eliminando plan:', error);
        showNotification('Error eliminando plan', 'error');
    }
}

/**
 * Recarga los planes
 */
async function refreshPlans() {
    document.getElementById('loadingState').style.display = 'block';
    await loadDashboard();
}

/**
 * Carga el componente de chat
 */
function loadChatComponent() {
    // Implementar carga del componente de chat si existe
    const chatComponent = document.getElementById('chatComponent');
    if (chatComponent && currentPlan) {
        // Cargar chat con contexto del plan actual
    }
}

/**
 * Muestra una notificaci√≥n
 */
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

/**
 * Logout del usuario
 */
async function logout() {
    try {
        if (auth) {
            await auth.logout();
        }
        router.navigate('/');
    } catch (error) {
        console.error('Error en logout:', error);
        router.navigate('/');
    }
}

// Cargar dashboard cuando se monta el componente
if (document.readyState !== 'loading') {
    loadDashboard();
} else {
    document.addEventListener('DOMContentLoaded', loadDashboard);
}
</script>
