<!--
  Dashboard - Plan Carrera (Fase 1)
  - Un solo Plan Carrera por usuario
  - El plan se genera únicamente en el onboarding por la IA
  - El dashboard solo muestra:
      - Estado vacío (si no hay plan)
      - Card del plan (si existe)
  - NO múltiples planes
  - NO botón "Nuevo Plan Carrera"
-->

<div class="dashboard-page dashboard-clean">
    <!-- HEADER (misma estructura que index / styles dashboard-clean) -->
    <header class="dashboard-header dashboard-header-clean">
      <div class="header-content">
        <div class="header-left">
          <h1 class="dashboard-title">Hola, <span id="userName">Usuario</span></h1>
          <p class="dashboard-subtitle">Tu plan de carrera</p>
        </div>
        <div class="header-right">
          <button type="button" class="btn-secondary btn-ghost" onclick="logout()">Cerrar sesión</button>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="dashboard-main dashboard-main-clean">
      <!-- LOADING -->
      <div class="loading-state" id="loadingState" hidden>
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <p>Cargando...</p>
        </div>
      </div>

      <!-- PLAN CARD -->
      <section class="plan-card-section" id="planCardSection" style="display:none;">
        <div id="planCardContainer"></div>
      </section>

      <!-- EMPTY STATE -->
      <section class="empty-state" id="emptyState" hidden>
        <div class="empty-content">
          <p class="empty-message">Aún no tienes un Plan de Carrera creado.</p>
          <p class="empty-hint">Regístrate y completa el onboarding para que la IA genere tu plan según tus opciones.</p>
        </div>
      </section>

      <!-- ERROR -->
      <div class="error-state" id="errorState" hidden>
        <div class="error-content">
          <p id="errorMessage"></p>
          <button type="button" class="btn-primary" onclick="loadDashboard()">Reintentar</button>
        </div>
      </div>
    </main>
</div>
  
  <script>
  /*
    Dashboard logic
    - 1 usuario = 1 plan
    - El plan proviene del onboarding (IA)
  */
  
  let currentPlan = null;
  
  function loadDashboard() {
    try {
      if (!auth || !auth.isAuthenticated()) {
        router.navigate('/login');
        return;
      }
  
      const user = auth.getUser();
      document.getElementById('userName').textContent =
        user.name || user.email || 'Usuario';
  
      showState('loading');
  
      // Un solo plan por usuario: getUserPlans devuelve array; tomamos el primero
      function finish(plan) {
        currentPlan = plan || null;
        if (currentPlan) {
          if (!currentPlan.id) currentPlan.id = 'local-' + (currentPlan.created_at ? new Date(currentPlan.created_at).getTime() : Date.now());
          renderPlanCard(currentPlan);
          showState('plan');
        } else {
          showState('empty');
        }
      }
  
      if (typeof planService !== 'undefined' && planService && planService.getUserPlans) {
        planService.getUserPlans(user.id)
          .then(plans => finish(plans && plans.length ? plans[0] : null))
          .catch(() => {
            try {
              const saved = localStorage.getItem('currentPlan');
              finish(saved ? JSON.parse(saved) : null);
            } catch (e) { finish(null); }
          });
      } else {
        try {
          const saved = localStorage.getItem('currentPlan');
          finish(saved ? JSON.parse(saved) : null);
        } catch (e) { finish(null); }
      }
  
    } catch (err) {
      console.error(err);
      showError('Error inesperado al cargar el dashboard');
    }
  }
  
  function renderPlanCard(plan) {
    const container = document.getElementById('planCardContainer');
    if (!container) return;

    const content = typeof plan.plan_content === 'string'
      ? (() => { try { return JSON.parse(plan.plan_content); } catch (e) { return {}; } })()
      : (plan.plan_content || plan);
    const title = plan.title || content.title || 'Plan de carrera';
    const description = plan.description || content.description || '';
    const objective = plan.objective || content.objective || '';
    const deadline = plan.estimated_duration || content.estimatedDuration || content.estimated_duration || '';
    const created = plan.created_at ? formatDate(plan.created_at) : '';
    let what = description;
    if (!what && content.phases && content.phases.length > 0) {
      const t = content.phases[0].topics || content.phases[0].learning_objectives || [];
      what = t.slice(0, 3).join(', ');
    }

    container.innerHTML = `
      <article class="plan-career-card" onclick="openPlan('${escapeAttr(plan.id)}')" role="button" tabindex="0">
        <h2 class="plan-career-card-title">${escapeHtml(title)}</h2>
        ${what ? `<p class="plan-career-card-field"><span class="label">Qué vas a estudiar</span>${escapeHtml(what)}</p>` : ''}
        ${objective ? `<p class="plan-career-card-field"><span class="label">Objetivo principal</span>${escapeHtml(objective)}</p>` : ''}
        ${deadline ? `<p class="plan-career-card-field"><span class="label">Plazo estimado</span>${escapeHtml(deadline)}</p>` : ''}
        ${created ? `<p class="plan-career-card-field plan-career-card-date"><span class="label">Fecha de creación</span>${escapeHtml(created)}</p>` : ''}
        <p class="plan-career-card-cta">Ver detalle del plan →</p>
      </article>
    `;
  }

  function escapeAttr(text) {
    if (text == null) return '';
    return String(text).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }
  
  function openPlan(planId) {
    router.navigate(`/dashboard/plan/${planId}`);
  }
  
  /* =====================
     Helpers
  ===================== */
  
  function showState(state) {
    const loadingEl = document.getElementById('loadingState');
    const emptyEl = document.getElementById('emptyState');
    const planSection = document.getElementById('planCardSection');
    const errorEl = document.getElementById('errorState');

    loadingEl?.setAttribute('hidden', '');
    emptyEl?.setAttribute('hidden', '');
    errorEl?.setAttribute('hidden', '');
    if (planSection) {
      planSection.setAttribute('hidden', '');
      planSection.style.display = 'none';
    }

    if (state === 'plan') {
      if (planSection) {
        planSection.removeAttribute('hidden');
        planSection.style.display = 'block';
      }
    } else {
      const id = state === 'loading' ? 'loadingState' : state === 'empty' ? 'emptyState' : 'errorState';
      document.getElementById(id)?.removeAttribute('hidden');
    }
  }
  
  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    showState('error');
  }
  
  function formatDate(date) {
    return new Date(date).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
  
  function logout() {
    auth.logout();
    router.navigate('/');
  }
  
  document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
  