<div class="dashboard-page">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="dashboard-title" id="dashboardTitle">Mis Planes de Carrera</h1>
                <p class="dashboard-subtitle" id="dashboardSubtitle">Generados con IA personalizada</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="userName">Usuario</span>
                    <button class="btn-secondary" onclick="logout()">Cerrar SesiÃ³n</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Action Bar -->
        <section class="action-bar">
            <button class="btn-primary" onclick="showCreatePlanModal()">
                â• Nuevo Plan de Carrera
            </button>
            <button class="btn-secondary" onclick="refreshPlans()">
                ğŸ”„ Actualizar
            </button>
        </section>

        <!-- Plans List -->
        <section class="plans-section" id="plansSection" style="display: none;">
            <div class="plans-grid" id="plansGrid">
                <!-- Los planes se cargarÃ¡n dinÃ¡micamente -->
            </div>
        </section>

        <!-- Empty State -->
        <section class="empty-state" id="emptyState">
            <div class="empty-content">
                <div class="empty-icon">ğŸ“š</div>
                <h2>No tienes planes aÃºn</h2>
                <p>Â¡Comienza tu viaje de aprendizaje!</p>
                <button class="btn-primary btn-large" onclick="showCreatePlanModal()">
                    Crear Tu Primer Plan
                </button>
            </div>
        </section>

        <!-- Loading State -->
        <div class="loading-state" id="loadingState" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h3>Cargando tus planes...</h3>
            </div>
        </div>

        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-content">
                <div class="error-icon">âš ï¸</div>
                <h2>Error cargando planes</h2>
                <p id="errorMessage"></p>
                <button class="btn-primary" onclick="loadDashboard()">Reintentar</button>
            </div>
        </div>
    </main>

    <!-- Create Plan Modal -->
    <div class="modal" id="createPlanModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Plan de Carrera</h2>
                <button class="modal-close" onclick="closeCreatePlanModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡s listo para crear un nuevo plan personalizado con IA?</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    Se te harÃ¡n algunas preguntas sobre tus intereses, disponibilidad y objetivos.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCreatePlanModal()">Cancelar</button>
                <button class="btn-primary" onclick="startNewPlanOnboarding()">Comenzar</button>
            </div>
        </div>
    </div>

    <!-- Chat Component -->
    <div id="chatComponent"></div>
</div>

<script>
/**
 * Script del Dashboard mejorado
 * Maneja mÃºltiples planes generados por IA desde Supabase
 */

let userPlans = [];
let currentPlan = null;
let currentPlanId = null;

/**
 * Inicializa el dashboard
 */
async function loadDashboard() {
    try {
        // Verificar autenticaciÃ³n
        if (!auth.isAuthenticated()) {
            router.navigate('/register');
            return;
        }

        const user = auth.getUser();
        
        // âœ… SI NO tiene plan (es primera vez), redirigir al onboarding
        if (!user || !user.has_plan) {
            console.log('âš ï¸ Usuario sin plan, redirigiendo al onboarding');
            router.navigate('/onboarding');
            return;
        }

        console.log('ğŸ“Š Cargando dashboard para:', user.name);

        // Actualizar informaciÃ³n del usuario
        document.getElementById('userName').textContent = user.name;

        // Mostrar loading
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('plansSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';

        // Cargar planes del usuario
        if (planService) {
            userPlans = await planService.getUserPlans(user.id);
            console.log('âœ… Planes cargados:', userPlans.length);
        } else {
            console.warn('âš ï¸ PlanService no disponible, usando localStorage');
            const savedPlan = localStorage.getItem('currentPlan');
            if (savedPlan) {
                userPlans = [JSON.parse(savedPlan)];
            }
        }

        // Ocultar loading
        document.getElementById('loadingState').style.display = 'none';

        // Renderizar planes o mostrar empty state
        if (userPlans && userPlans.length > 0) {
            renderPlans();
            document.getElementById('plansSection').style.display = 'block';
        } else {
            document.getElementById('emptyState').style.display = 'block';
        }

        // Cargar componente de chat
        loadChatComponent();
    } catch (error) {
        console.error('âŒ Error cargando dashboard:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
    }
}

/**
 * Renderiza la lista de planes del usuario
 */
function renderPlans() {
    const plansGrid = document.getElementById('plansGrid');

    plansGrid.innerHTML = userPlans
        .map((plan) => {
            const planContent = plan.plan_content || plan;
            return `
        <div class="plan-card" onclick="selectPlan('${plan.id}', this)">
            <div class="plan-card-header">
                <h3 class="plan-card-title">${planContent.title || 'Plan sin tÃ­tulo'}</h3>
                <div class="plan-card-meta">
                    <span class="plan-badge">ğŸ“š ${planContent.totalPhases || planContent.phases?.length || 0} fases</span>
                </div>
            </div>
            
            <p class="plan-card-description">${
                planContent.description || 'Plan de carrera personalizado'
            }</p>
            
            <div class="plan-card-footer">
                <div class="plan-date">${new Date(plan.created_at).toLocaleDateString('es-ES')}</div>
                <div class="plan-actions">
                    <button class="btn-small" onclick="event.stopPropagation(); editPlan('${plan.id}')">
                        âœï¸
                    </button>
                    <button class="btn-small" onclick="event.stopPropagation(); deletePlanConfirm('${plan.id}')">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        </div>
        `;
        })
        .join('');
}

/**
 * Selecciona un plan y lo muestra
 */
async function selectPlan(planId, element) {
    currentPlanId = planId;
    currentPlan = userPlans.find((p) => p.id === planId);

    // Actualizar UI
    document.querySelectorAll('.plan-card').forEach((card) => {
        card.classList.remove('active');
    });
    if (element) {
        element.classList.add('active');
    }

    // Navigar a la vista de plan
    router.navigate(`/plan/${planId}`);
}

/**
 * Abre el modal para crear un nuevo plan
 */
function showCreatePlanModal() {
    document.getElementById('createPlanModal').style.display = 'flex';
}

/**
 * Cierra el modal de crear plan
 */
function closeCreatePlanModal() {
    document.getElementById('createPlanModal').style.display = 'none';
}

/**
 * Inicia el onboarding para crear un nuevo plan
 */
function startNewPlanOnboarding() {
    closeCreatePlanModal();
    // Resetear estado del onboarding
    localStorage.removeItem('currentQuestion');
    localStorage.removeItem('userAnswers');
    router.navigate('/onboarding');
}

/**
 * Edita un plan existente
 */
function editPlan(planId) {
    console.log('âœï¸ Editando plan:', planId);
    // TODO: Implementar ediciÃ³n de plan
    showNotification('Funcionalidad de ediciÃ³n prÃ³ximamente', 'info');
}

/**
 * Confirma eliminaciÃ³n de plan
 */
function deletePlanConfirm(planId) {
    if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar este plan?')) {
        deletePlan(planId);
    }
}

/**
 * Elimina un plan
 */
async function deletePlan(planId) {
    try {
        if (planService) {
            await planService.deletePlan(planId);
        }

        // Actualizar lista
        userPlans = userPlans.filter((p) => p.id !== planId);
        renderPlans();

        showNotification('Plan eliminado', 'success');

        if (userPlans.length === 0) {
            document.getElementById('plansSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
    } catch (error) {
        console.error('Error eliminando plan:', error);
        showNotification('Error eliminando plan', 'error');
    }
}

/**
 * Recarga los planes
 */
async function refreshPlans() {
    document.getElementById('loadingState').style.display = 'block';
    await loadDashboard();
}

/**
 * Carga el componente de chat
 */
function loadChatComponent() {
    // Implementar carga del componente de chat si existe
    const chatComponent = document.getElementById('chatComponent');
    if (chatComponent && currentPlan) {
        // Cargar chat con contexto del plan actual
    }
}

/**
 * Muestra una notificaciÃ³n
 */
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

/**
 * Logout del usuario
 */
async function logout() {
    try {
        if (auth) {
            await auth.logout();
        }
        router.navigate('/');
    } catch (error) {
        console.error('Error en logout:', error);
        router.navigate('/');
    }
}

// Cargar dashboard cuando se monta el componente
if (document.readyState !== 'loading') {
    loadDashboard();
} else {
    document.addEventListener('DOMContentLoaded', loadDashboard);
}
}

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', initDashboard);
</script>
