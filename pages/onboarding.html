<!--
  Onboarding: card grande tipo modal con chat.
  Groq pregunta "¬øCu√°l ser√° tu plan?", el usuario responde y Groq genera el plan.
  Al terminar se guarda y redirige al dashboard.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboarding - Plan Carrera Pro</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/onboarding.css">
</head>
<body class="onboarding-page">
    <div class="onboarding-chat-wrapper">
        <div class="chat-container card animate-fade-in" id="onboardingChatCard">
            <!-- Header igual que el sidebar del dashboard: Groq AI + En l√≠nea -->
            <header class="chat-header">
                <div class="flex items-center gap-3">
                    <div class="avatar relative">
                        <div class="avatar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" class="chat-icon"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <span class="status-indicator"></span>
                    </div>
                    <div>
                        <h2 class="text-white text-lg font-semibold m-0">Groq AI</h2>
                        <span class="text-white opacity-90 text-sm">En l√≠nea ¬∑ ¬øCu√°l ser√° tu plan?</span>
                    </div>
                </div>
            </header>

            <!-- Cuerpo del chat: mismo markup que el sidebar del dashboard -->
            <div class="p-6 overflow-y-auto custom-scrollbar" id="onboardingMessages">
                <div class="mb-4" data-role="assistant">
                    <div class="card bg-gray-100 p-4 rounded-xl soft-shadow" style="border-bottom-left-radius: 0.25rem; max-width: 80%;">
                        <p class="text-gray-800 text-sm mb-2">¬øQu√© te gustar√≠a aprender? Cu√©ntame y te ayudo a definir tu camino.</p>
                        <p class="text-gray-600 text-sm">Por ejemplo: SQL, Python, ciencia de datos, desarrollo web, machine learning‚Ä¶</p>
                    </div>
                </div>
                <div class="p-4 flex flex-wrap gap-2" id="onboardingQuickQuestions">
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero aprender Python">Quiero aprender Python</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero aprender SQL y an√°lisis de datos">SQL y an√°lisis de datos</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero ser desarrollador web">Desarrollador web</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-question="Quiero hacer ciencia de datos y ML">Ciencia de datos y ML</button>
                </div>
                <div class="p-4 text-center text-gray-500 text-sm" id="onboardingTyping" style="display: none;">
                    <div class="animate-spin w-5 h-5 border-2 border-gray-300 border-t-primary-500 rounded-full mx-auto mb-2"></div>
                    <span>Groq est√° escribiendo‚Ä¶</span>
                </div>
                <div class="chat-input-container p-4 border-t border-gray-200">
                    <input type="text" class="input" id="onboardingUserInput" placeholder="Escribe tu mensaje‚Ä¶" autocomplete="off" />
                    <button type="button" class="btn btn-primary rounded-xl" id="onboardingSendChatBtn" title="Enviar" aria-label="Enviar">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <button type="button" class="btn btn-primary btn-block" id="onboardingGeneratePlanBtn">Generar mi plan con Groq</button>
                </div>
            </div>

            <!-- Estado: generando -->
            <div class="onboarding-loading-state card p-12 text-center" id="loadingState" style="display: none; padding: 3rem; text-align: center; background: white;">
                <div class="loading-content">
                    <div class="animate-spin w-12 h-12 border-3 border-gray-200 border-t-primary-500 rounded-full mx-auto mb-4"></div>
                    <h3 style="color: var(--gray-800); font-size: var(--font-size-xl); margin-bottom: 0.5rem; font-weight: 600;">Creando tu plan personalizado</h3>
                    <p style="color: var(--gray-600); font-size: var(--font-size-base);">Groq est√° dise√±ando tu plan de carrera.</p>
                </div>
            </div>

            <!-- Estado: √©xito ‚Üí ir al dashboard -->
            <div class="onboarding-results-state card p-12 text-center" id="resultsState">
                <div class="results-content">
                    <div class="success-icon" style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2 style="color: var(--gray-800); font-size: var(--font-size-2xl); margin-bottom: 1rem; font-weight: 600;">Plan generado</h2>
                    <p class="onboarding-plan-title" id="planTitle" style="color: var(--gray-600); font-size: var(--font-size-lg); margin-bottom: 2rem;"></p>
                    <button type="button" class="btn-primary btn-large soft-ui-button" id="goToDashboardBtn" style="padding: 1rem 2rem; font-size: var(--font-size-lg);">
                        Ver mi Dashboard
                    </button>
                </div>
            </div>

            <!-- Estado: error -->
            <div class="onboarding-error-state card p-12 text-center" id="errorState">
                <div class="error-content">
                    <p id="errorMessage" style="color: var(--gray-700); font-size: var(--font-size-base); margin-bottom: 1.5rem;"></p>
                    <button type="button" class="btn-primary soft-ui-button" id="retryBtn">Intentar de nuevo</button>
                </div>
            </div>
        </div>
    </div>

<script>
(function() {
    var API_BASE = typeof window.API_BASE_URL !== 'undefined' ? window.API_BASE_URL : '';
    var WELCOME_GROQ = '¬øQu√© te gustar√≠a aprender? Por ejemplo: SQL, Python, ciencia de datos, desarrollo web, machine learning‚Ä¶';

    var chatState = {
        messages: [{ role: 'assistant', content: WELCOME_GROQ }],
        loading: false
    };

    function showState(state) {
        var chatEl = document.getElementById('onboardingChatCard');
        var loadingEl = document.getElementById('loadingState');
        var resultsEl = document.getElementById('resultsState');
        var errorEl = document.getElementById('errorState');
        [chatEl, loadingEl, resultsEl, errorEl].forEach(function(el) {
            if (el) el.style.display = 'none';
        });
        if (state === 'chat' && chatEl) chatEl.style.display = 'block';
        if (state === 'loading' && loadingEl) loadingEl.style.display = 'block';
        if (state === 'results' && resultsEl) resultsEl.style.display = 'block';
        if (state === 'error' && errorEl) errorEl.style.display = 'block';
    }

    function escapeHtml(text) {
        if (text == null) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    function nl2br(text) {
        return escapeHtml(text || '').replace(/\n/g, '<br>');
    }

    /** Renderiza mensajes con la misma estructura que el chatbot del dashboard (chatbot-msg, chatbot-msg-content) */
    function renderOnboardingMessages() {
        var container = document.getElementById('onboardingMessages');
        if (!container) return;
        container.innerHTML = '';
        chatState.messages.forEach(function(msg) {
            var div = document.createElement('div');
            div.className = 'chatbot-msg chatbot-msg-' + msg.role;
            div.setAttribute('data-role', msg.role);
            var isAssistant = msg.role === 'assistant';
            var content = isAssistant ? nl2br(msg.content) : escapeHtml(msg.content);
            div.innerHTML = '<div class="chatbot-msg-content">' + (isAssistant ? '<p>' + content + '</p>' : '<p>' + content + '</p>') + '</div>';
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
        var qq = document.getElementById('onboardingQuickQuestions');
        if (qq) qq.style.display = chatState.messages.length <= 1 ? 'flex' : 'none';
    }

    function setChatLoading(loading) {
        chatState.loading = loading;
        var typingEl = document.getElementById('onboardingTyping');
        if (typingEl) typingEl.style.display = loading ? 'flex' : 'none';
        if (loading) {
            var messages = document.getElementById('onboardingMessages');
            if (messages) messages.scrollTop = messages.scrollHeight;
        }
    }

    /** Env√≠a mensaje a Groq (misma l√≥gica que el sidebar: POST /chat/message) */
    function sendChatMessage(text) {
        var msg = (text || '').trim();
        if (!msg || chatState.loading) {
            console.log('Mensaje vac√≠o o en estado de carga:', { msg: msg, loading: chatState.loading });
            return;
        }

        console.log('Enviando mensaje:', msg);
        chatState.messages.push({ role: 'user', content: msg });
        renderOnboardingMessages();
        setChatLoading(true);

        function done(responseText) {
            chatState.messages.push({ role: 'assistant', content: responseText });
            renderOnboardingMessages();
            setChatLoading(false);
        }
        function fail(errMsg) {
            chatState.messages.push({ role: 'assistant', content: errMsg || 'No pude procesar tu mensaje. Int√©ntalo de nuevo.' });
            renderOnboardingMessages();
            setChatLoading(false);
        }

        if (!API_BASE) {
            console.error('API_BASE no configurado:', API_BASE);
            fail('Backend no configurado (API_BASE_URL). Configura el servidor para usar Groq.');
            return;
        }

        console.log('Haciendo fetch a:', API_BASE + '/chat/message');
        fetch(API_BASE + '/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
        })
            .then(function(res) {
                console.log('Respuesta del servidor:', res.status, res.ok);
                return res.json().then(function(data) {
                    if (!res.ok) {
                        var detail = data.detail;
                        var msg = typeof detail === 'string' ? detail : (Array.isArray(detail) ? (detail[0] && detail[0].msg) || JSON.stringify(detail) : 'Error ' + res.status);
                        throw new Error(msg || 'Error en el servidor');
                    }
                    return data;
                }).catch(function(e) {
                    if (e instanceof Error && e.message) throw e;
                    throw new Error('Error ' + res.status);
                });
            })
            .then(function(data) {
                console.log('Datos recibidos:', data);
                done(data.message || 'Sin respuesta');
            })
            .catch(function(err) {
                console.error('Onboarding chat (Groq):', err);
                fail(err && err.message ? err.message : 'No se pudo conectar. ¬øEst√° el backend en ' + API_BASE + '?');
            });
    }

    function savePlanAndUser(planPayload) {
        var raw = planPayload.generated_plan || planPayload.plan_content || planPayload;
        var planContent = typeof raw === 'string' ? (function() { try { return JSON.parse(raw); } catch (e) { return raw; } })() : raw;
        var supaUser = window.supabase && window.supabase.getCurrentUser ? window.supabase.getCurrentUser() : null;
        if (!supaUser || !supaUser.id) {
            console.error('Usuario Supabase no disponible para guardar plan');
            return;
        }
        if (typeof planService === 'undefined' || !planService || !planService.savePlan) {
            console.error('PlanService no disponible');
            return;
        }
        planService.savePlan(supaUser.id, planContent, { source: 'onboarding-chat' })
            .then(function(res) {
                if (!res || !res.success) {
                    throw new Error('Error al guardar el plan en Supabase');
                }
                console.log('Plan guardado en Supabase con id:', res.plan.id);
                window.auth && window.auth.markOnboardingComplete(supaUser.id);
            })
            .catch(function(err) {
                console.error('Error guardando plan en Supabase:', err);
            });
    }

    function goToDashboard() {
        console.log('goToDashboard() ejecut√°ndose');
        console.log('window.router disponible:', !!window.router);
        console.log('window.router.navigate disponible:', !!(window.router && window.router.navigate));
        console.log('window.router.handleRoute disponible:', !!(window.router && window.router.handleRoute));
        
        sessionStorage.removeItem('fromRegister');
        sessionStorage.removeItem('creatingNewPlan');
        
        // Usar el router del sistema de routing
        if (window.router && window.router.navigate) {
            console.log('Usando window.router.navigate("/dashboard")');
            window.router.navigate('/dashboard');
            
            // Forzar el manejo de la ruta
            setTimeout(() => {
                console.log('Forzando handleRoute()');
                if (window.router.handleRoute) {
                    window.router.handleRoute();
                }
            }, 50);
        } else if (window.location.hash !== undefined) {
            console.log('Usando window.location.hash = "#/dashboard"');
            window.location.hash = '#/dashboard';
            
            // Forzar el manejo de la ruta
            setTimeout(() => {
                if (window.router && window.router.handleRoute) {
                    window.router.handleRoute();
                }
            }, 50);
        } else {
            console.log('Usando window.location.href con hash');
            // √öltimo recurso: recargar la p√°gina con el hash
            window.location.href = window.location.pathname + '#/dashboard';
        }
    }

    /** Genera el plan con Groq (POST /ai/generate-plan-from-chat) usando el √∫ltimo mensaje del usuario o todos */
    function generatePlanFromConversation() {
        var userMessages = chatState.messages.filter(function(m) { return m.role === 'user'; }).map(function(m) { return m.content; });
        var messageToSend = userMessages.length > 0 ? (userMessages.length === 1 ? userMessages[0] : userMessages.join(' | ')) : '';
        if (!messageToSend.trim()) {
            if (window.showNotification) window.showNotification('Escribe al menos un mensaje sobre qu√© quieres estudiar antes de generar el plan.', 'warning');
            else alert('Escribe al menos un mensaje sobre qu√© quieres estudiar antes de generar el plan.');
            return;
        }

        showState('loading');
        function onError(err) {
            console.error('Error generando plan:', err);
            showState('error');
            var errMsg = document.getElementById('errorMessage');
            if (errMsg) errMsg.textContent = (err && err.message) || (typeof err === 'string' ? err : 'No se pudo generar el plan.');
        }

        if (!API_BASE) {
            onError(new Error('Backend no configurado (API_BASE_URL).'));
            return;
        }

        fetch(API_BASE + '/ai/generate-plan-from-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageToSend })
        })
            .then(function(res) {
                return res.json().then(function(data) {
                    if (!res.ok) {
                        var d = data.detail || data.message;
                        throw new Error(typeof d === 'string' ? d : (Array.isArray(d) ? (d[0] && d[0].msg) || JSON.stringify(d) : 'Error ' + res.status));
                    }
                    return data;
                });
            })
            .then(function(data) {
                savePlanAndUser(data);
                var titleEl = document.getElementById('planTitle');
                if (titleEl) titleEl.textContent = data.title || 'Tu plan de carrera';
                showState('results');
            })
            .catch(onError);
    }

    function navigateTo(path) {
        if (window.router && window.router.navigate) {
            window.router.navigate(path);
        } else if (window.location.hash !== undefined) {
            window.location.hash = '#' + path;
        } else {
            window.location.href = window.location.pathname + '#' + path;
        }
    }

    async function initOnboarding() {
        var auth = window.auth;
        var supaUser = window.supabase && window.supabase.getCurrentUser ? window.supabase.getCurrentUser() : null;
        if (auth && auth.loadCurrentUser && auth.isAuthenticated && !auth.isAuthenticated() && supaUser && supaUser.id) {
            try {
                await auth.loadCurrentUser();
            } catch (e) {}
        }
        var isAuthed = (auth && auth.isAuthenticated && auth.isAuthenticated()) || (supaUser && supaUser.id);
        if (!isAuthed) {
            navigateTo('/register');
            return;
        }

        var fromRegister = sessionStorage.getItem('fromRegister');
        var creatingNewPlan = sessionStorage.getItem('creatingNewPlan');
        if (!fromRegister && !creatingNewPlan) {
            navigateTo('/dashboard');
            return;
        }

        var chatCard = document.getElementById('onboardingChatCard');
        if (chatCard && chatCard.getAttribute('data-init') === 'true') return;
        if (chatCard) chatCard.setAttribute('data-init', 'true');

        chatState.messages = [{ role: 'assistant', content: WELCOME_GROQ }];
        chatState.loading = false;
        showState('chat');
        renderOnboardingMessages();

        var input = document.getElementById('onboardingUserInput');
        var sendChatBtn = document.getElementById('onboardingSendChatBtn');
        var generatePlanBtn = document.getElementById('onboardingGeneratePlanBtn');
        var goBtn = document.getElementById('goToDashboardBtn');
        var retryBtn = document.getElementById('retryBtn');

        console.log('Elementos encontrados:', {
            input: !!input,
            sendChatBtn: !!sendChatBtn,
            generatePlanBtn: !!generatePlanBtn,
            goBtn: !!goBtn,
            retryBtn: !!retryBtn
        });

        if (sendChatBtn && input) {
            console.log('Asignando evento click al bot√≥n de enviar');
            sendChatBtn.addEventListener('click', function(e) {
                console.log('Bot√≥n de enviar clickeado');
                e.preventDefault();
                var message = input.value.trim();
                if (message) {
                    sendChatMessage(message);
                    input.value = '';
                } else {
                    console.log('Mensaje vac√≠o, no se env√≠a');
                }
            });
        } else {
            console.log('No se encontraron elementos para asignar evento:', { sendChatBtn: !!sendChatBtn, input: !!input });
        }
        if (input) {
            console.log('Asignando evento keydown al input');
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    console.log('Tecla Enter presionada');
                    e.preventDefault();
                    var message = input.value.trim();
                    if (message) {
                        sendChatMessage(message);
                        input.value = '';
                    } else {
                        console.log('Mensaje vac√≠o, no se env√≠a');
                    }
                }
            });
        }
        if (generatePlanBtn) generatePlanBtn.addEventListener('click', generatePlanFromConversation);
        if (goBtn) {
            console.log('Asignando evento click al bot√≥n "Ver mi Dashboard"');
            goBtn.addEventListener('click', function(e) {
                console.log('Bot√≥n "Ver mi Dashboard" clickeado');
                e.preventDefault();
                goToDashboard();
            });
        }
        if (retryBtn) retryBtn.addEventListener('click', function() { showState('chat'); });

        var quickQuestions = document.getElementById('onboardingQuickQuestions');
        if (quickQuestions) {
            quickQuestions.querySelectorAll('.btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var q = this.getAttribute('data-question');
                    if (q) { sendChatMessage(q); }
                });
            });
        }
    }

    // Exponer la funci√≥n para que la llame el router
    window.initOnboarding = initOnboarding;
    
    // Inicializar autom√°ticamente si el DOM est√° listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initOnboarding);
    } else {
        initOnboarding();
    }
})();
</script>
</body>
</html>
