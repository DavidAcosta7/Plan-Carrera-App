<div class="onboarding-page">
    <div class="onboarding-container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
            <div class="progress-steps">
                <div class="step active" data-step="1">1</div>
                <div class="step" data-step="2">2</div>
                <div class="step" data-step="3">3</div>
                <div class="step" data-step="4">4</div>
                <div class="step" data-step="5">5</div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="question-card" id="questionCard">
            <div class="question-header">
                <h2 id="questionTitle">Pregunta 1 de 5</h2>
                <p id="questionSubtitle">Cu√©ntanos sobre ti para crear tu plan perfecto</p>
            </div>

            <div class="question-content" id="questionContent">
                <!-- Las preguntas se cargar√°n din√°micamente -->
            </div>

            <div class="question-actions">
                <button class="btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">
                    Anterior
                </button>
                <button class="btn-primary" id="nextBtn" onclick="nextQuestion()">
                    Siguiente
                </button>
                <button class="btn-primary" id="generateBtn" onclick="generatePlan()" style="display: none;">
                    Generar Mi Plan con IA
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-state" id="loadingState" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h3>Creando tu plan personalizado...</h3>
                <p>Claude IA est√° analizando tus respuestas para generar tu plan de carrera perfecto.</p>
            </div>
        </div>

        <!-- Results -->
        <div class="results-state" id="resultsState" style="display: none;">
            <div class="results-content">
                <div class="success-icon">üéâ</div>
                <h2>¬°Plan Generado Exitosamente!</h2>
                <p id="planTitle" style="font-size: 1.3em; font-weight: 600; margin: 20px 0;"></p>
                <p id="planDescription">Tu plan personalizado ha sido creado por Claude IA</p>
                <button class="btn-primary btn-large" onclick="goToDashboard()">
                    Ver Mi Dashboard
                </button>
            </div>
        </div>

        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-content">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h2>Error al generar el plan</h2>
                <p id="errorMessage"></p>
                <button class="btn-primary" onclick="retryGeneration()">
                    Intentar de nuevo
                </button>
                <button class="btn-secondary" onclick="previousQuestion()">
                    Volver
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Script de Onboarding mejorado con integraci√≥n de Claude IA
 * Flujo: Preguntas ‚Üí Respuestas guardadas ‚Üí IA genera plan ‚Üí Guardado en BD ‚Üí Dashboard
 */

// Definici√≥n de preguntas del onboarding
const questions = [
    {
        id: 1,
        title: "¬øCu√°l es tu nivel actual?",
        subtitle: "Esto nos ayudar√° a adaptar el contenido a tu experiencia",
        type: "single",
        fieldName: "level",
        options: [
            { value: "beginner", label: "üå± Principiante", description: "Nunca he programado o tengo conocimientos b√°sicos" },
            { value: "intermediate", label: "üöÄ Intermedio", description: "Tengo experiencia en alg√∫n lenguaje o tecnolog√≠a" },
            { value: "advanced", label: "üí™ Avanzado", description: "Soy desarrollador con experiencia buscando especializarme" }
        ]
    },
    {
        id: 2,
        title: "¬øQu√© quieres aprender?",
        subtitle: "Selecciona las √°reas que m√°s te interesan",
        type: "multiple",
        fieldName: "interests",
        options: [
            { value: "python", label: "üêç Python", description: "Data Science, AI, Backend" },
            { value: "javascript", label: "‚ö° JavaScript", description: "Frontend, Backend, Apps" },
            { value: "sql", label: "üóÑÔ∏è SQL", description: "Bases de datos, An√°lisis" },
            { value: "mobile", label: "üì± Mobile", description: "iOS, Android, React Native" },
            { value: "devops", label: "üîß DevOps", description: "Cloud, Docker, CI/CD" },
            { value: "ai", label: "ü§ñ AI/ML", description: "Machine Learning, Deep Learning" }
        ]
    },
    {
        id: 3,
        title: "¬øCu√°nto tiempo tienes por d√≠a?",
        subtitle: "S√© realista para crear un plan sostenible",
        type: "single",
        fieldName: "timePerDay",
        options: [
            { value: "1", label: "‚è∞ 1 hora", description: "Poco tiempo pero constante" },
            { value: "2", label: "‚è∞ 2 horas", description: "Un buen balance" },
            { value: "3", label: "‚è∞ 3+ horas", description: "Mucho tiempo disponible" }
        ]
    },
    {
        id: 4,
        title: "¬øCu√°l es tu objetivo principal?",
        subtitle: "Esto ayudar√° a enfocar tu plan hacia metas espec√≠ficas",
        type: "single",
        fieldName: "goal",
        options: [
            { value: "job", label: "üíº Conseguir trabajo", description: "Quiero mi primer trabajo o cambiar de carrera" },
            { value: "freelance", label: "üéØ Freelance", description: "Quiero trabajar por mi cuenta" },
            { value: "promotion", label: "üìà Promoci√≥n", description: "Quiero ascender en mi trabajo actual" },
            { value: "project", label: "üöÄ Proyecto personal", description: "Quiero construir mi propio proyecto" }
        ]
    },
    {
        id: 5,
        title: "¬øEn cu√°nto tiempo quieres lograrlo?",
        subtitle: "Establece un plazo realista para tus metas",
        type: "single",
        fieldName: "deadline",
        options: [
            { value: "3", label: "üìÖ 3 meses", description: "Acelerado e intenso" },
            { value: "6", label: "üìÖ 6 meses", description: "Balanceado y sostenible" },
            { value: "12", label: "üìÖ 1 a√±o", description: "Profundo y completo" }
        ]
    }
];

// Estado global del onboarding
let currentQuestion = 0;
let userAnswers = {};
let currentPlanId = null;

/**
 * Inicializa el flujo de onboarding
 */
function initOnboarding() {
    // Verificar autenticaci√≥n
    if (!auth.isAuthenticated()) {
        router.navigate('/register');
        return;
    }

    const user = auth.getUser();
    
    // ‚úÖ SI ya tiene plan (NO es primera vez), redirigir al dashboard
    if (user && user.has_plan) {
        console.log('‚ö†Ô∏è Usuario ya tiene plan, redirigiendo al dashboard');
        router.navigate('/dashboard');
        return;
    }

    console.log('‚úÖ Iniciando onboarding para:', user.name);
    renderQuestion();
}

/**
 * Renderiza la pregunta actual
 */
function renderQuestion() {
    const question = questions[currentQuestion];
    const questionTitle = document.getElementById('questionTitle');
    const questionSubtitle = document.getElementById('questionSubtitle');
    const questionContent = document.getElementById('questionContent');

    questionTitle.textContent = `Pregunta ${currentQuestion + 1} de ${questions.length}`;
    questionSubtitle.textContent = question.subtitle;

    // Actualizar progress bar
    updateProgress();

    // Renderizar contenido seg√∫n el tipo
    if (question.type === 'single') {
        questionContent.innerHTML = renderSingleOptions(question);
    } else if (question.type === 'multiple') {
        questionContent.innerHTML = renderMultipleOptions(question);
    } else if (question.type === 'text') {
        questionContent.innerHTML = renderTextQuestion(question);
    }

    // Actualizar botones
    updateButtons();

    // Restaurar respuesta previa si existe
    restoreAnswer();
}

/**
 * Renderiza opciones de selecci√≥n √∫nica
 */
function renderSingleOptions(question) {
    return question.options
        .map(
            (option) => `
        <div class="option-card" onclick="selectOption('${option.value}', 'single')">
            <div class="option-radio">
                <input type="radio" name="question${question.id}" value="${option.value}" id="opt_${option.value}">
                <label for="opt_${option.value}"></label>
            </div>
            <div class="option-content">
                <div class="option-label">${option.label}</div>
                <div class="option-description">${option.description}</div>
            </div>
        </div>
    `
        )
        .join('');
}

/**
 * Renderiza opciones de selecci√≥n m√∫ltiple
 */
function renderMultipleOptions(question) {
    return question.options
        .map(
            (option) => `
        <div class="option-card" onclick="selectOption('${option.value}', 'multiple')">
            <div class="option-checkbox">
                <input type="checkbox" name="question${question.id}" value="${option.value}" id="opt_${option.value}">
                <label for="opt_${option.value}"></label>
            </div>
            <div class="option-content">
                <div class="option-label">${option.label}</div>
                <div class="option-description">${option.description}</div>
            </div>
        </div>
    `
        )
        .join('');
}

/**
 * Renderiza pregunta de texto libre
 */
function renderTextQuestion(question) {
    const answer = userAnswers[question.fieldName] || '';
    return `
        <div class="text-question">
            <textarea 
                id="textAnswer" 
                placeholder="${question.placeholder || 'Escribe tu respuesta...'}"
                rows="4"
                onchange="saveTextAnswer()"
            >${answer}</textarea>
        </div>
    `;
}

/**
 * Selecciona una opci√≥n (single o multiple)
 */
function selectOption(value, type) {
    const question = questions[currentQuestion];

    if (type === 'single') {
        // Deseleccionar todas las opciones
        document.querySelectorAll('.option-card').forEach((card) => {
            card.classList.remove('selected');
        });

        // Seleccionar la opci√≥n actual
        const currentCard = event.currentTarget;
        currentCard.classList.add('selected');

        // Marcar el radio button
        const radio = currentCard.querySelector('input[type="radio"]');
        if (radio) radio.checked = true;

        userAnswers[question.fieldName] = value;
        console.log(`‚úÖ Respondido: ${question.fieldName} = ${value}`);
    } else if (type === 'multiple') {
        const currentCard = event.currentTarget;
        currentCard.classList.toggle('selected');

        const checkbox = currentCard.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = !checkbox.checked;

        // Guardar array de valores seleccionados
        const selected = Array.from(
            document.querySelectorAll('.option-card.selected input[type="checkbox"]')
        ).map((cb) => cb.value);

        userAnswers[question.fieldName] = selected;
        console.log(`‚úÖ Respondido: ${question.fieldName} =`, selected);
    }
}

/**
 * Guarda respuesta de texto
 */
function saveTextAnswer() {
    const question = questions[currentQuestion];
    const textarea = document.getElementById('textAnswer');
    userAnswers[question.fieldName] = textarea.value;
    console.log(`‚úÖ Respondido: ${question.fieldName} = ${textarea.value}`);
}

/**
 * Restaura respuesta anterior si existe
 */
function restoreAnswer() {
    const question = questions[currentQuestion];
    const answer = userAnswers[question.fieldName];

    if (!answer) return;

    if (question.type === 'single') {
        const radio = document.querySelector(`input[value="${answer}"]`);
        if (radio) {
            radio.checked = true;
            radio.closest('.option-card').classList.add('selected');
        }
    } else if (question.type === 'multiple') {
        if (Array.isArray(answer)) {
            answer.forEach((value) => {
                const checkbox = document.querySelector(`input[value="${value}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('.option-card').classList.add('selected');
                }
            });
        }
    } else if (question.type === 'text') {
        const textarea = document.getElementById('textAnswer');
        if (textarea) textarea.value = answer;
    }
}

/**
 * Actualiza barra de progreso
 */
function updateProgress() {
    const progressFill = document.getElementById('progressFill');
    const progressSteps = document.querySelectorAll('.step');
    const progress = ((currentQuestion + 1) / questions.length) * 100;

    progressFill.style.width = `${progress}%`;

    progressSteps.forEach((step, index) => {
        if (index < currentQuestion) {
            step.classList.add('active');
        } else if (index === currentQuestion) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
}

/**
 * Actualiza estado de botones
 */
function updateButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const generateBtn = document.getElementById('generateBtn');

    if (currentQuestion > 0) {
        prevBtn.style.display = 'block';
    } else {
        prevBtn.style.display = 'none';
    }

    if (currentQuestion === questions.length - 1) {
        nextBtn.style.display = 'none';
        generateBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        generateBtn.style.display = 'none';
    }
}

/**
 * Ir a la siguiente pregunta
 */
function nextQuestion() {
    // Validar que la pregunta actual est√© respondida
    const question = questions[currentQuestion];
    const answer = userAnswers[question.fieldName];

    if (!answer || (Array.isArray(answer) && answer.length === 0)) {
        showNotification('Por favor responde la pregunta antes de continuar', 'warning');
        return;
    }

    if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        renderQuestion();
    }
}

/**
 * Volver a la pregunta anterior
 */
function previousQuestion() {
    if (currentQuestion > 0) {
        currentQuestion--;
        renderQuestion();
    }
}

/**
 * Genera el plan con IA y lo guarda
 */
async function generatePlan() {
    // Validar que todas las preguntas est√©n respondidas
    for (let i = 0; i < questions.length; i++) {
        const question = questions[i];
        const answer = userAnswers[question.fieldName];
        if (!answer || (Array.isArray(answer) && answer.length === 0)) {
            currentQuestion = i;
            renderQuestion();
            showNotification('Por favor responde todas las preguntas antes de continuar', 'warning');
            return;
        }
    }

    // Mostrar loading
    document.getElementById('questionCard').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';

    try {
        console.log('üìù Enviando respuestas a Claude IA:', userAnswers);

        // Llamar a AIService para generar el plan
        if (!aiService.isConfigured) {
            throw new Error(
                'Claude API no est√° configurada. Por favor configura VITE_ANTHROPIC_API_KEY'
            );
        }

        // Generar plan con IA
        const result = await aiService.generateCareerPlan(userAnswers);

        if (!result.success) {
            throw new Error('Error generando plan');
        }

        const generatedPlan = result.plan;
        console.log('‚úÖ Plan generado por IA:', generatedPlan);

        // Guardar plan en Supabase
        const user = auth.getUser();
        if (user && planService) {
            const saveResult = await planService.savePlan(user.id, generatedPlan, userAnswers);
            currentPlanId = saveResult.plan.id;
            console.log('‚úÖ Plan guardado en BD:', currentPlanId);
        } else {
            console.warn('‚ö†Ô∏è Guardando plan en localStorage');
            localStorage.setItem('currentPlan', JSON.stringify(generatedPlan));
        }

        // ‚úÖ Marcar que el usuario YA TIENE PLAN
        if (user) {
            user.has_plan = true;
            user.plan = generatedPlan;
            localStorage.setItem('user', JSON.stringify(user));
            console.log('‚úÖ Usuario marcado como has_plan=true');
        }

        // Marcar onboarding como completado
        if (user) {
            await auth.markOnboardingComplete(user.id);
        }

        // Mostrar resultados
        setTimeout(() => {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsState').style.display = 'block';
            document.getElementById('planTitle').textContent = generatedPlan.title;
            document.getElementById('planDescription').textContent = generatedPlan.description;
        }, 1500);
    } catch (error) {
        console.error('‚ùå Error generando plan:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
    }
}

/**
 * Intenta generar el plan de nuevo
 */
function retryGeneration() {
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('questionCard').style.display = 'block';
    currentQuestion = questions.length - 1;
    renderQuestion();
}

/**
 * Navega al dashboard
 */
function goToDashboard() {
    router.navigate('/dashboard');
}

/**
 * Muestra notificaci√≥n
 */
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Iniciar onboarding cuando se cargue
document.addEventListener('DOMContentLoaded', () => {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initOnboarding);
    } else {
        initOnboarding();
    }
});

// Fallback si el DOM ya se carg√≥
if (document.readyState !== 'loading') {
    initOnboarding();
}
// Inicializar cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', initOnboarding);
</script>
